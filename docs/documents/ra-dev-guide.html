---
layout: page
title: OCFリソースエージェント開発者ガイド
permalink: /documents/ra-dev-guide
categories:
- 読み物
---
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.10" />
<title>OCFリソースエージェント開発者ガイド</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>OCFリソースエージェント開発者ガイド</h1>
<span id="author">Florian Haas (hastexo)</span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="dlist"><dl>
<dt class="hdlist1">
著者
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
Florian Haas (hastexo)
</p>
</li>
<li>
<p>
John Shi (SUSE): ocft README 原文
</p>
</li>
<li>
<p>
Dejan Muhamedagic (SUSE): ocft ドキュメント見直し
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
著作権表示
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
Copyright &#169; 2010, 2011 <a href="http://www.linbit.com">LINBIT HA-Solutions GmbH</a>
</p>
</li>
<li>
<p>
Copyright &#169; 2011 <a href="http://www.novell.com">Novell, Inc.</a>
</p>
</li>
<li>
<p>
Copyright &#169; 2011 <a href="http://www.suse.com">SUSE Linux GmbH</a>
</p>
</li>
<li>
<p>
Copyright &#169; 2011 <a href="http://www.hastexo.com">hastexo Professional Services GmbH</a>
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
ライセンス情報
</dt>
<dd>
<p>
この文書に含まれる文章、図は、クリエイティブ・コモンズ表示 - 継承 3.0 非移植 (CC BY-SA 3.0) によってライセンスされています。
</p>
<div class="ulist"><ul>
<li>
<p>
CC-BY-SA の要約は <a href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a> で参照可能です。
</p>
</li>
<li>
<p>
ライセンス全文は  <a href="http://creativecommons.org/licenses/by-sa/3.0/legalcode">http://creativecommons.org/licenses/by-sa/3.0/legalcode</a> で参照可能です。
</p>
</li>
<li>
<p>
CC-BY-SA に従い、この文書を再配布もしくは改変する場合は、原文の URL を提供する必要があります。
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
日本語訳について
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
翻訳: <a href="http://linux-ha.osdn.jp/">Linux-HA Japan project</a>
</p>
</li>
<li>
<p>
著作権表示: Copyright &#169; 2018 <a href="http://linux-ha.osdn.jp/">Linux-HA Japan project</a>
</p>
</li>
<li>
<p>
原文参照先URL: <a href="https://github.com/ClusterLabs/resource-agents/tree/master/doc/dev-guides">https://github.com/ClusterLabs/resource-agents/tree/master/doc/dev-guides</a>
</p>
</li>
<li>
<p>
日本語訳リポジトリ: <a href="https://github.com/linux-ha-japan/doc-ja/tree/master/linux-ha-doc/dev-guides">https://github.com/linux-ha-japan/doc-ja/tree/master/linux-ha-doc/dev-guides</a>
</p>
</li>
<li>
<p>
改版履歴:
</p>
<div class="ulist"><ul>
<li>
<p>
2018/04/28: resource-agents v4.1.1 版へ追従、翻訳文の全面見直し。
</p>
</li>
<li>
<p>
2012/02/27: 初版公開。ra-dev-guide 1.0.0版をベースに日本語訳作成。
</p>
</li>
</ul></div>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="_はじめに">1. はじめに</h2>
<div class="sectionbody">
<div class="paragraph"><p>本書は、OCF(Open Cluster Framework)準拠のクラスタリソースエージェントに関連するすべての開発者、メンテナおよびコントリビュータのためのガイドとリファレンスです。本書は、リソースエージェントの構造や一般的な機能の説明と、リソースエージェントAPIの説明、リソースエージェント作成者に役に立つヒントやヘルプを提供します。</p></div>
<div class="sect2">
<h3 id="_リソースエージェントとは何か">1.1. リソースエージェントとは何か？</h3>
<div class="paragraph"><p>リソースエージェントとは、クラスタリソースを管理する実行ファイルです。クラスタリソースとは、「クラスタが管理するものはすべてリソースである」という以外に正式な定義はありません。いくつか例を挙げると、IPアドレス、ファイルシステム、データベースサービス、仮想マシン全体など多種多様なものがクラスタリソースになりえます。</p></div>
</div>
<div class="sect2">
<h3 id="_誰がまたは何がリソースエージェントを使うのか">1.2. 誰がまたは何がリソースエージェントを使うのか？</h3>
<div class="paragraph"><p>OCF(Open Cluster Framework)に準拠したクラスタ管理アプリケーションが、本書で説明されているリソースエージェントを使ってリソースを管理することができます。本書の執筆時点では、Linuxプラットフォーム用に2つのOCF準拠クラスタ管理アプリケーションがあります。</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Pacemaker</em> : CorosyncおよびHeartbeatクラスタメッセージングフレームワークの両方をサポートするクラスタマネージャ。Pacemakerは、Linux-HAプロジェクトから進化し独立しています。
</p>
</li>
<li>
<p>
<em>RGmanager</em> : Red Hat Cluster Suiteでバンドルされているクラスタマネージャ。これは、Corosyncクラスタメッセージングフレームワークだけをサポートします。
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_リソースエージェントはどの言語で記述するのか">1.3. リソースエージェントはどの言語で記述するのか？</h3>
<div class="paragraph"><p>OCF準拠リソースエージェントは <em>どのような</em> プログラミング言語ででも実装可能です。APIは言語を問いません。しかし、ほとんどのリソースエージェントはシェルスクリプトとして実装されています。本ガイドは、主にシェル言語で記述されたサンプルコードを使います。</p></div>
</div>
<div class="sect2">
<h3 id="_名前付け規約はありますか">1.4. 名前付け規約はありますか?</h3>
<div class="paragraph"><p>あります! リソースエージェントの名称は次の規約に従うという合意があります: リソースエージェントの名前は小文字とし、単語の区切りはダッシュ文字とすること(例: <code>example-agent-name</code>)。</p></div>
<div class="paragraph"><p>既存のエージェントの中にはこの規約に従っているものもそうでないものもありますが、今後作成するエージェントは必ずこのルールに従ったものにするという意図です。</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api定義">2. API定義</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_a_id__environment_variables_a_環境変数">2.1. <a id="_environment_variables"></a>環境変数</h3>
<div class="paragraph"><p>リソースエージェントは、管理するリソースの設定情報を全て環境変数を通して受け取ります。これらの環境変数の名前は必ず、リソースのパラメタ名に <code>OCF_RESKEY_</code> という接頭語を付加したものになります。たとえば、リソースに <code>192.168.1.1</code> という値が設定された <code>ip</code> というパラメタがある場合、リソースエージェントはこの値を保持している <code>OCF_RESKEY_ip</code> という環境変数にアクセスすることができます。</p></div>
<div class="paragraph"><p>ユーザによる設定が必須ではないリソースパラメータ(すなわち、リソースエージェントメタデータのパラメータ定義で <code>required="true"</code> が指定されていないパラメータ)に対しては、リソースエージェントは以下を行う必要があります。</p></div>
<div class="ulist"><ul>
<li>
<p>
適切なデフォルト値を提供すること。これはメタデータの中に明記すべきです。慣例として、リソースエージェントでは、<code>OCF_RESKEY_&lt;parametername&gt;_default</code> と名付けられた変数にこのデフォルトを保持するようにします。
</p>
</li>
<li>
<p>
もしくは、未設定の場合に正しく対処すること。
</p>
</li>
</ul></div>
<div class="paragraph"><p>さらに、クラスタマネージャは <em>meta</em> リソースパラメータも使用することがあります。これらはリソース設定が直接適用されるものではなく、クラスタリソースマネージャがリソースを <em>どのように</em> 管理したいかを指定するものです。たとえば、Pacemakerクラスタマネージャは <code>target-role</code> metaパラメータを使って、リソースが起動されるべきか停止されるべきかを指定します。</p></div>
<div class="paragraph"><p>metaパラメータは <code>OCF_RESKEY_CRM_meta_</code> 名前空間でリソースエージェントに渡されます(この場合、ハイフンはアンダースコアに変換されます)。したがって、 <code>target-role</code> 属性は <code>OCF_RESKEY_CRM_meta_target_role</code> と名付けられた環境変数にマッピングされます。</p></div>
<div class="paragraph"><p>その他のシステム環境変数については<a href="#_script_variables">スクリプト変数</a>の項に記載しています。</p></div>
</div>
<div class="sect2">
<h3 id="_アクション">2.2. アクション</h3>
<div class="paragraph"><p>全てのリソースエージェントは必ず1つのコマンドライン引数を取ります。これにはリソースエージェントが実行しようとしているアクションを指定します。以下のアクションは全てのリソースエージェントがサポートしなければなりません。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>start</code>&#8201;&#8212;&#8201;リソースを起動します。
</p>
</li>
<li>
<p>
<code>stop</code>&#8201;&#8212;&#8201;リソースを停止します。
</p>
</li>
<li>
<p>
<code>monitor</code>&#8201;&#8212;&#8201;リソースの状態を問合せします。
</p>
</li>
<li>
<p>
<code>meta-data</code>&#8201;&#8212;&#8201;リソースエージェントメタデータをダンプします。
</p>
</li>
</ul></div>
<div class="paragraph"><p>これに加えて、リソースエージェントは以下のアクションをオプションとしてサポートすることもあります。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>promote</code>&#8201;&#8212;&#8201;リソースの役割を <code>Master</code> に変更します(Master/Slaveリソースのみ)。
</p>
</li>
<li>
<p>
<code>demote</code>&#8201;&#8212;&#8201;リソースの役割を <code>Slave</code> に変更します(Master/Slaveリソースのみ)。
</p>
</li>
<li>
<p>
<code>migrate_to</code> および <code>migrate_from</code>&#8201;&#8212;&#8201;リソースのライブマイグレーションを実施します。
</p>
</li>
<li>
<p>
<code>validate-all</code> --リソースの設定を検証します。
</p>
</li>
<li>
<p>
<code>usage</code> or <code>help</code>&#8201;&#8212;&#8201;リソースエージェントがクラスタマネージャではなくコマンドラインから起動された場合のため、使用方法を表示します。
</p>
</li>
<li>
<p>
<code>notify</code>&#8201;&#8212;&#8201;他のクローンリソースの状態変化をリソースに通知します。
</p>
</li>
<li>
<p>
<code>status</code>&#8201;&#8212;&#8201; <code>monitor</code> の歴史的な(非推奨の)別名。
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">訳注: 上記以外にも <code>reload</code> というアクションが存在しますが、原文でも記載していないため本ドキュメントでは説明しません。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_タイムアウト">2.3. タイムアウト</h3>
<div class="paragraph"><p>アクションのタイムアウトの処理は、リソースエージェントの範囲の外で実施されます。リソースエージェントアクションがどれぐらいの時間実行されているかを監視し、もし所定の時間内にアクションが終了しない場合にそのアクションを停止するのは、クラスタマネージャの責任です。したがって、リソースエージェント自身は、タイムアウトをチェックする必要はありません。</p></div>
<div class="paragraph"><p>しかし、実際的なタイムアウト値をリソースエージェントからユーザに <em>推奨</em> することはできます(正しく設定すれば、クラスタマネージャによって適切に実行される)。リソースエージェントから、その提案タイムアウト値をどのように提示するかについては<a href="#_metadata">以下のセクション</a>を参照してください。</p></div>
</div>
<div class="sect2">
<h3 id="_a_id__metadata_a_メタデータ">2.4. <a id="_metadata"></a>メタデータ</h3>
<div class="paragraph"><p>全てのリソースエージェントは、その目的やサポートしているパラメータを一連の XML メタデータとして記述しなければなりません。このメタデータは、クラスタ管理アプリケーションでオンラインヘルプとして利用されたり、リソースエージェントのmanページをこれから生成したりします。以下は、架空のリソースエージェントにおける一連の架空のメタデータです。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">&lt;?xml</span></span> <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="font-weight: bold"><span style="color: #000080">?&gt;</span></span>
<span style="font-weight: bold"><span style="color: #000080">&lt;!DOCTYPE</span></span> <span style="color: #009900">resource</span>-<span style="color: #009900">agent</span> <span style="color: #009900">SYSTEM</span> <span style="color: #FF0000">"ra-api-1.dtd"</span><span style="font-weight: bold"><span style="color: #000080">&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;resource-agent</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"foobar"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;version&gt;</span></span>0.1<span style="font-weight: bold"><span style="color: #0000FF">&lt;/version&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;longdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
This is a fictitious example resource agent written for the
OCF Resource Agent Developers Guide.
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/longdesc&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;shortdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Example resource agent
  for budding OCF RA developers<span style="font-weight: bold"><span style="color: #0000FF">&lt;/shortdesc&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;parameters&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;parameter</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"eggs"</span> <span style="color: #009900">unique</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;longdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      Number of eggs, an example numeric parameter
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/longdesc&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;shortdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Number of eggs<span style="font-weight: bold"><span style="color: #0000FF">&lt;/shortdesc&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;content</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"integer"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/parameter&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;parameter</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"superfrobnicate"</span> <span style="color: #009900">unique</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;longdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      Enable superfrobnication, an example boolean parameter
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/longdesc&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;shortdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Enable superfrobnication<span style="font-weight: bold"><span style="color: #0000FF">&lt;/shortdesc&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;content</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"boolean"</span> <span style="color: #009900">default</span><span style="color: #990000">=</span><span style="color: #FF0000">"false"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/parameter&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;parameter</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"datadir"</span> <span style="color: #009900">unique</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="color: #009900">required</span><span style="color: #990000">=</span><span style="color: #FF0000">"1"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;longdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
      Data directory, an example string parameter
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;/longdesc&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;shortdesc</span></span> <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>Data directory<span style="font-weight: bold"><span style="color: #0000FF">&lt;/shortdesc&gt;</span></span>
      <span style="font-weight: bold"><span style="color: #0000FF">&lt;content</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"string"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/parameter&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/parameters&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;actions&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"start"</span>        <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"stop"</span>         <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"monitor"</span>      <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span>
                                <span style="color: #009900">interval</span><span style="color: #990000">=</span><span style="color: #FF0000">"10"</span> <span style="color: #009900">depth</span><span style="color: #990000">=</span><span style="color: #FF0000">"0"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"notify"</span>       <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"reload"</span>       <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"migrate_to"</span>   <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"migrate_from"</span> <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"meta-data"</span>    <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"5"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;action</span></span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"validate-all"</span>   <span style="color: #009900">timeout</span><span style="color: #990000">=</span><span style="color: #FF0000">"20"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
  <span style="font-weight: bold"><span style="color: #0000FF">&lt;/actions&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/resource-agent&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p><code>resource-agent</code> 要素はリソースエージェント毎に必ず1つ記述する必要があり、リソースエージェントの <code>name</code> と <code>version</code> を定義します。</p></div>
<div class="paragraph"><p><code>resource-agent</code> の <code>longdesc</code> と <code>shortdesc</code> 要素は、リソースエージェントの機能について長い説明文と短い説明文を記述します。 <code>shortdesc</code> は、そのリソースエージェントが何をするものなのかの一行説明文で、通常簡易な一覧表などで使われます。それに対して <code>longdesc</code> は、リソースエージェントについてできるだけ詳細に説明します。</p></div>
<div class="paragraph"><p><code>parameters</code> 要素はリソースエージェントのパラメータについて説明するもので、子供として <code>parameter</code> 要素をリソースエージェントがサポートするパラメータの数だけ持ちます。</p></div>
<div class="paragraph"><p>それぞれの <code>parameter</code> は、<code>resource-agent</code> 本体と同様に <code>shortdesc</code> と <code>longdesc</code> の記述があり、さらにそのパラメータに期待される内容を説明する <code>content</code> 要素が続きます。</p></div>
<div class="paragraph"><p><code>content</code> 要素には、4種類の属性が存在します。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>type</code> はパラメータタイプ( <code>string</code> , <code>integer</code> , <code>boolean</code> )を設定します。デフォルト: <code>string</code>
</p>
</li>
<li>
<p>
<code>required</code> はパラメータ設定が必須( <code>required="true"</code> )であるかオプション( <code>required="false"</code> )であるかを設定します。
</p>
</li>
<li>
<p>
オプションパラメータに関しては、<code>default</code> 属性によって適切なデフォルト値を提供することが慣例になっています。
</p>
</li>
<li>
<p>
最後に、 <code>unique</code> 属性(許容値: <code>true</code> 、 <code>false</code> )は、この特定のリソースタイプのこのパラメータに対してその指定した値がクラスタ全体で一意となる必要があることを示します。たとえば、高可用フローティングIPアドレスは <code>unique</code> として宣言されています。それは一つのIPアドレスはクラスタ全体で一箇所でのみ実行すべきものであり、重複を避けるためです。
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>actions</code> のリストは、リソースエージェントがサポートしているアクションを定義します。</p></div>
<div class="paragraph"><p>それぞれの <code>action</code> は、それぞれ固有の <code>timeout</code> 値を記載します。これは、アクションに対して設定すべき <em>最小限の</em> タイムアウトはいくつか、というヒントをユーザに示しています。これは、ある種のリソース(例: IPアドレスやファイルシステム) では短時間で起動／停止できたり、別のリソース(例: データベース) は数分かかったりする、ということに対応するためです。</p></div>
<div class="paragraph"><p>さらに、繰り返しアクション(例: <code>monitor</code> )は、推奨の最小実行間隔 <code>interval</code> も指定する必要があります。 <code>interval</code> は、同じアクションの連続した2回の実行の間隔を指定します。 <code>timeout</code> と同じく、この値のデフォルト設定はできません。つまり、最小実行間隔をどのように設定すればいよいかというヒントをユーザに示しているにすぎません。</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_id__return_codes_a_戻り値">3. <a id="_return_codes"></a>戻り値</h2>
<div class="sectionbody">
<div class="paragraph"><p>リソースエージェントは、アクションの実行に対して必ず定義された戻り値で終了し、アクションの実行結果を呼び出し元に通知しなければなりません。以下の項では戻り値について詳細に説明します。</p></div>
<div class="sect2">
<h3 id="_code_ocf_success_code_0">3.1. <code>OCF_SUCCESS</code> (0)</h3>
<div class="paragraph"><p>アクションは正しく終了しました。これは次の各アクション <code>start</code>, <code>stop</code>, <code>promote</code>, <code>demote</code>, <code>migrate_from</code>, <code>migrate_to</code>, <code>meta_data</code>, <code>help</code>, <code>usage</code> が成功したときに対する戻り値です。</p></div>
<div class="paragraph"><p>しかし、<code>monitor</code> (および非推奨の別名 <code>status</code>)に対しては少し異なる慣習が適用されます。</p></div>
<div class="ulist"><ul>
<li>
<p>
primitive (stateless)リソースに関しては、 <code>monitor</code> からの <code>OCF_SUCCESS</code> は、リソースが実行されていることを意味します。非実行中で正常停止しているリソースに対しては <code>OCF_NOT_RUNNING</code> を返す必要があります。
</p>
</li>
<li>
<p>
master/slave (stateful)リソースに関しては、 <code>monitor</code> からの <code>OCF_SUCCESS</code> は、リソースが <em>Slaveモードで</em> 実行されていることを意味します。Masterモードで実行されているリソースは <code>OCF_RUNNING_MASTER</code> を、正常停止しているリソースは <code>OCF_NOT_RUNNING</code> を返す必要があります。
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_err_generic_code_1">3.2. <code>OCF_ERR_GENERIC</code> (1)</h3>
<div class="paragraph"><p>アクションは汎用エラーを返しました。リソースエージェントは、以下の項で定義している特定のエラーコードでは問題を正確に表せない場合にのみ、この終了コードを使用すべきです。</p></div>
<div class="paragraph"><p>クラスタリソースマネージャは、この終了コードを <em>ソフト</em> エラーとして解釈します。この場合、特に設定されていない限り、リソースマネージャは <code>OCF_ERR_GENERIC</code> で失敗したところと同じ場所でリカバリしようと試みます。つまり通常は同じノードでリソースが再起動されます。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_err_args_code_2">3.3. <code>OCF_ERR_ARGS</code> (2)</h3>
<div class="paragraph"><p>リソースの設定がこのマシン上では不正です。例えば、ノード上には存在しないパスを参照している場合などです。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">リソースエージェントは、サポートしていないアクションを実行するよう指示された場合、このエラーを返すべきではありません。その代わり、そのような状況では、OCF_ERR_UNIMPLEMENTEDを返すべきです。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_code_ocf_err_unimplemented_code_3">3.4. <code>OCF_ERR_UNIMPLEMENTED</code> (3)</h3>
<div class="paragraph"><p>リソースエージェントは、エージェントに実装されていないアクションを実行するよう指示されました。</p></div>
<div class="paragraph"><p>リソースエージェントのアクションは全てが必須なわけではありません。<code>promote</code>, <code>demote</code>, <code>migrate_to</code>, <code>migrate_from</code>, <code>notify</code> は全て省略可能なアクションであり、リソースエージェントが実装している場合もしていない場合もあります。たとえば、statefulではないリソースを誤って master/slave リソースとして設定してしまった場合、リソースエージェントは <code>promote</code> および <code>demote</code> アクションから <code>OCF_ERR_UNIMPLEMENTED</code> を返却して、ユーザに設定ミスを警告すべきです。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_err_perm_code_4">3.5. <code>OCF_ERR_PERM</code> (4)</h3>
<div class="paragraph"><p>アクションは、不十分なアクセス権限により失敗しました。これは、エージェントがあるファイルを開くことができなかった、指定されたソケットでlistenできなかった、ディレクトリに書き込みができなかった、あるいはそれに類する原因によるものです。</p></div>
<div class="paragraph"><p>クライアントリソースマネージャは、この終了コードを <em>ハード</em> エラーとして解釈します。この場合、特に設定されていないかぎり、リソースマネージャは別のノード(アクセス権限に関する問題がないと思われるノード)でリソースを再起動することにより、このエラーで故障したリソースをリカバリしようとします。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_err_installed_code_5">3.6. <code>OCF_ERR_INSTALLED</code> (5)</h3>
<div class="paragraph"><p>アクションは、それが実行されたノードに必要コンポーネントがなかったために失敗しました。これには必要なバイナリが実行可能ではなかった、あるいは重要な設定ファイルが読み込めなかった、などがありえます。</p></div>
<div class="paragraph"><p>クラスタマネージャは、この終了コードを <em>ハード</em> エラーとして解釈します。この場合、特に設定されていないかぎり、リソースマネージャは別のノード(必要ファイルやバイナリがあると思われるノード)でリソースを再起動することによって、このエラーで故障したリソースをリカバリしようとします。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_err_configured_code_6">3.7. <code>OCF_ERR_CONFIGURED</code> (6)</h3>
<div class="paragraph"><p>アクションは、ユーザがリソースの設定を誤っていたため失敗しました。たとえば、ユーザが、本来整数を設定すべきパラメータに英数字文字列を設定したような場合です。</p></div>
<div class="paragraph"><p>クラスタリソースマネージャは、この終了コードを <em>致命的</em> エラーとして解釈します。この設定エラーはクラスタ全体で発生するものであるため、同じノードではもちろんのこと、異なるノードでそのようなリソースをリカバリするのは意味がありません。リソースがこのエラーで故障すると、クラスタマネージャはリソースを停止しようとし、管理者の介入を待ちます。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_not_running_code_7">3.8. <code>OCF_NOT_RUNNING</code> (7)</h3>
<div class="paragraph"><p>リソースは実行されていないと判断しました。これは、 <code>monitor</code> アクションのみによって返される終了コードです。これにはリソースが <em>正常に</em> 終了した場合も、そもそも起動されていなかった場合も含みます。</p></div>
<div class="paragraph"><p>リソースがエラー状態のせいで実行されていない場合、 <code>monitor</code> アクションは、代わりに <code>OCF_ERR_</code> 終了コードの一つか、 <code>OCF_FAILED_MASTER</code> を返すべきです。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_running_master_code_8">3.9. <code>OCF_RUNNING_MASTER</code> (8)</h3>
<div class="paragraph"><p>リソースは、 <code>Master</code> roleで実行されていると判断しました。これは stateful (Master/Slave)リソースにのみ、そして、その <code>monitor</code> アクションにのみ適用されます。</p></div>
<div class="paragraph"><p>注意点として、「slaveモードで実行中である」ということを示す特定の終了コードはありません。これは正常実行中の primitive リソースと slave として実行している stateful リソースの間には機能的な違いは何も無いからです。<code>Slave</code> role として正常実行中の stateful リソースは、 <code>monitor</code> アクションに対しては単に <code>OCF_SUCCESS</code> を返すだけで良いです。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_failed_master_code_9">3.10. <code>OCF_FAILED_MASTER</code> (9)</h3>
<div class="paragraph"><p>リソースは <code>Master</code> roleで故障していると判断しました。これは stateful (Master/Slave)リソースにのみ、そして、その <code>monitor</code> アクションにのみ適用されます。</p></div>
<div class="paragraph"><p>クラスタリソースマネージャは、この終了コードを_ソフト_ エラーとして解釈します。この場合、特に設定されていない限り、リソースマネージャは <code>$OCF_FAILED_MASTER</code> で失敗したところと同じ場所でリカバリしようと試みます。つまり通常は同じノードでリソースの降格、停止、起動、昇格が行われます。</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_リソースエージェントの構造">4. リソースエージェントの構造</h2>
<div class="sectionbody">
<div class="paragraph"><p>典型的な(シェルベースの)リソースエージェントは、本項で列挙した順序に従った標準的な構成を持ちます。本項では <code>foobar</code> という名前の架空のリソースエージェントを用いて、実装すべきさまざまなアクションに対してリソースエージェントに期待する動作を記述します。</p></div>
<div class="sect2">
<h3 id="_リソースエージェントインタプリタ">4.1. リソースエージェントインタプリタ</h3>
<div class="paragraph"><p>スクリプトとして実装されたリソースは、標準の"shebang" (<code>#!</code>)ヘッダ構文を使い、そのインタプリタを指定しなければなりません。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>#!/bin/sh</code></pre>
</div></div>
<div class="paragraph"><p>リソースエージェントをシェルで記述する場合、一般的には標準シェルインタプリタ(<code>#!/bin/sh</code>)を指定することが好まれますが、これは必須ではありません。 <code>/bin/sh</code> 互換であると宣言したリソースエージェントでは、特定のシェル固有の構文(たとえば <code>bash</code> 固有の <code>${!variable}</code> 構文など)を使用してはいけません。そのようなリソースエージェントに対しては <code>checkbashisms</code> などの清書用ユーティリティを必要に応じて実行することが望ましいです。</p></div>
<div class="paragraph"><p>既存の <code>sh</code> 互換のリソースエージェントを、 <code>bash</code> や <code>ksh</code> 、その他一般的ではないシェルでしか実行できなくしてしまうパッチはレグレッションバグであるとみなされます。しかし新しいリソースエージェントにおいて、特定のシェル、たとえば <code>/bin/bash</code> をインタプリタとして明確に指定することは全く問題ありません。</p></div>
</div>
<div class="sect2">
<h3 id="_著者およびライセンス情報">4.2. 著者およびライセンス情報</h3>
<div class="paragraph"><p>リソースエージェントは、リソースエージェントの著者や著作権保持者、そして、リソースエージェントに適用されるライセンスを記載したコメントを記述する必要があります。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#   Resource Agent for managing foobar resources.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#   License:      GNU General Public License (GPL)</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#   (c) 2008-2010 John Doe, Jane Roe,</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#                 and Linux-HA contributors</span></span></tt></pre></div></div>
<div class="paragraph"><p>リソースエージェントが、複数のバージョンが存在するライセンスに当てはまる場合、最新のバージョンが適用されるものとします。</p></div>
</div>
<div class="sect2">
<h3 id="_a_id__initialization_a_初期化">4.3. <a id="_initialization"></a>初期化</h3>
<div class="paragraph"><p>すべてのシェルリソースエージェントは <code>ocf-shellfuncs</code> 関数ライブラリを読み込むようにします。以下の構文のように <code>$OCF_FUNCTIONS_DIR</code> を通して行います。これはテスト目的やドキュメント生成のためにコマンドラインから上書きできるようにするためです。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Initialization:</span></span>
<span style="color: #990000">:</span> <span style="color: #009900">${OCF_FUNCTIONS_DIR=${OCF_ROOT}/lib/heartbeat}</span>
<span style="color: #990000">.</span> <span style="color: #009900">${OCF_FUNCTIONS_DIR}</span>/ocf-shellfuncs</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_リソースエージェントのアクションを実装する関数">4.4. リソースエージェントのアクションを実装する関数</h3>
<div class="paragraph"><p>次に続けて、リソースエージェントが提供しているアクションを実装する関数を記述します。個別のアクションの詳細については<a href="#_resource_agent_actions">リソースエージェントのアクション</a>で説明します。</p></div>
</div>
<div class="sect2">
<h3 id="_実行ブロック">4.5. 実行ブロック</h3>
<div class="paragraph"><p>ここは、リソースエージェントが起動されたときに実際に実行される部分です。ここは大体において標準的な構造に従います。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># meta-data と usage は常に成功で終了します</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #009900">$__OCF_ACTION</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
meta-data<span style="color: #990000">)</span>      foobar_meta_data
                <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
                <span style="color: #990000">;;</span>
usage<span style="color: #990000">|</span><span style="font-weight: bold"><span style="color: #0000FF">help</span></span><span style="color: #990000">)</span>     foobar_usage
                <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
                <span style="color: #990000">;;</span>
<span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># meta-data と usage 以外はすべて必ずパラメータ検証を通すようにする</span></span>
foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

<span style="font-style: italic"><span style="color: #9A1900"># それぞれのアクションを適切な関数呼び出しに変換する</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #009900">$__OCF_ACTION</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
start<span style="color: #990000">)</span>          foobar_start<span style="color: #990000">;;</span>
stop<span style="color: #990000">)</span>           foobar_stop<span style="color: #990000">;;</span>
status<span style="color: #990000">|</span>monitor<span style="color: #990000">)</span> foobar_monitor<span style="color: #990000">;;</span>
promote<span style="color: #990000">)</span>        foobar_promote<span style="color: #990000">;;</span>
demote<span style="color: #990000">)</span>         foobar_demote<span style="color: #990000">;;</span>
notify<span style="color: #990000">)</span>         foobar_notify<span style="color: #990000">;;</span>
reload<span style="color: #990000">)</span>         ocf_log info <span style="color: #FF0000">"Reloading..."</span>
                foobar_start
                <span style="color: #990000">;;</span>
validate-all<span style="color: #990000">)</span>   <span style="color: #990000">;;</span>
<span style="color: #990000">*)</span>              foobar_usage
                <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_UNIMPLEMENTED</span>
                <span style="color: #990000">;;</span>
<span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>
<span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$?</span>

<span style="font-style: italic"><span style="color: #9A1900"># 必要であればデバッグメッセージのログ出力を行っても良い</span></span>
ocf_log debug <span style="color: #FF0000">"${OCF_RESOURCE_INSTANCE} $__OCF_ACTION returned $rc"</span>
<span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$rc</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_id__resource_agent_actions_a_リソースエージェントのアクション">5. <a id="_resource_agent_actions"></a>リソースエージェントのアクション</h2>
<div class="sectionbody">
<div class="paragraph"><p>それぞれのアクションは、リソースエージェントの中で別々の関数もしくはメソッドとして実装するのが一般的です。慣習として、通常は <code>&lt;agent&gt;_&lt;action&gt;</code> という名前をつけます。したがって、<code>foobar</code> の <code>start</code> アクションを実装する関数は <code>foobar_start()</code> という名前にします。</p></div>
<div class="paragraph"><p>一般論として、リソースエージェントが回復不可能な致命的なエラーに遭遇した場合、即座に終了する、例外を投げる、その他実行を中断することが許されます。この場合の例としては、設定上の問題、バイナリが存在しない、権限の問題、などがあげられます。これらのエラーについては必ずしも呼び出し元にエラーを返してくる必要はありません。</p></div>
<div class="paragraph"><p>エラーからの復旧動作は、クラスタマネージャがユーザの設定に基づいて適切に実行するべきものです。リソースエージェント側ではその設定についていかなる仮定も持ってはいけません。</p></div>
<div class="sect2">
<h3 id="_code_start_code_アクション">5.1. <code>start</code> アクション</h3>
<div class="paragraph"><p><code>start</code> アクションが起動されたときは、リソースエージェントは(リソースがまだ実行されていない場合は)リソースを起動しなければなりません。つまり、エージェントはリソースの設定を検証し、状態を確認し、リソースが実行されていない場合のみリソースを起動する、ということが必要になります。これらを行うためには、以下の例に示すように、最初に <code>validate_all</code> と <code>monitor</code> を実行するのが一般的な方法です。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_start()</span></span> {
    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースが既に実行中の場合はこの段階で終了する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
        ocf_log info <span style="color: #FF0000">"Resource is already running"</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
    <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># ここで実際のリソース起動を行う(なにか重大な問題が発生した場合は</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># $OCF_ERR_ エラーコードですぐに終了すること)</span></span>
    <span style="color: #990000">...</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソース起動を実行したら、正常に起動したかどうかをチェックする。</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># リソースが非同期で起動する場合は、エージェントはここで monitor</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 関数を繰り返す。もしリソースが所定のタイムアウト時間以内に起動</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># しなかった場合、クラスタマネージャが start アクションが失敗した</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># と判断する。</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">!</span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        ocf_log debug <span style="color: #FF0000">"Resource has not started yet, waiting"</span>
        sleep <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_code_stop_code_アクション">5.2. <code>stop</code> アクション</h3>
<div class="paragraph"><p><code>stop</code> アクションが起動されたときは、リソースエージェントは(リソースが実行中の場合は)リソースを停止しなければなりません。つまり、エージェントはリソースの設定を検証し、状態を確認し、リソースがその時点で実行中の場合のみ停止する、ということが必要になります。これらを行うためには、以下の例に示すように、最初に <code>validate_all</code> と <code>monitor</code> を実行するのが一般的な方法です。ここで覚えておくべき重要なことは、<code>stop</code> は強制的な操作であるということです。つまりリソースエージェントは、その権限でできることのすべてを使って(ノードの再起動やシャットダウンまではできないにしても)リソースを停止しなければならないということです。以下の例を見てください。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_stop()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> rc

    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    foobar_monitor
    <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$?</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"$rc"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="color: #FF0000">"$OCF_SUCCESS"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># 現在実行中である。正常で想定した動作である。</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource is currently running"</span>
            <span style="color: #990000">;;</span>
        <span style="color: #FF0000">"$OCF_RUNNING_MASTER"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># Master として実行中である。停止の前に降格が必要である。</span></span>
            ocf_log info <span style="color: #FF0000">"Resource is currently running as Master"</span>
            foobar_demote <span style="color: #990000">||</span> <span style="color: #990000">\</span>
                ocf_log warn <span style="color: #FF0000">"Demote failed, trying to stop anyway"</span>
            <span style="color: #990000">;;</span>
        <span style="color: #FF0000">"$OCF_NOT_RUNNING"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># 現在停止中である。何もする必要はない。</span></span>
            ocf_log info <span style="color: #FF0000">"Resource is already stopped"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
            <span style="color: #990000">;;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># ここで実際のリソース停止を行う(なにか重大な問題が発生した場合は</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># $OCF_ERR_ エラーコードですぐに終了すること)</span></span>
    <span style="color: #990000">...</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソース停止を実行したら、正常に停止したかどうかをチェックする。</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># リソースが非同期で停止する場合は、エージェントはここで monitor</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 関数を繰り返す。もしリソースが所定のタイムアウト時間以内に停止</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># しなかった場合、クラスタマネージャが stop アクションが失敗した</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># と判断する。</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        ocf_log debug <span style="color: #FF0000">"Resource has not stopped yet, waiting"</span>
        sleep <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>

}</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">stop 操作が成功したときに期待される終了コードは <code>$OCF_SUCCESS</code> です( <code>$OCF_NOT_RUNNING</code> ではありません)。</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">stop操作が失敗した場合は危険な状況を生み出す可能性があります。この場合クラスタマネージャはほぼ必ずノードを隔離(fencing)することによって問題を解決しようとします。言い換えると、クラスタマネージャは stop 操作が失敗したノードをクラスタから強制的に排除します。この方法は最終的にはデータを保護することに役に立つのですが、アプリケーションやそのユーザに混乱を引き起こします。したがってリソースエージェントは、適切なリソース停止手段をすべて使い果たした場合にのみ、エラー終了とするべきなのです。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_a_id__literal_monitor_literal_action_a_code_monitor_code_アクション">5.3. <a id="_literal_monitor_literal_action"></a><code>monitor</code> アクション</h3>
<div class="paragraph"><p><code>monitor</code> アクションは、リソースの現在の状態を確認します。このとき次の3種類の状態を判別しなければなりません。</p></div>
<div class="ulist"><ul>
<li>
<p>
リソースは現在実行中です(<code>$OCF_SUCCESS</code> を返す)
</p>
</li>
<li>
<p>
リソースは正常に停止しています(<code>$OCF_NOT_RUNNING</code> を返す)
</p>
</li>
<li>
<p>
リソースに何か問題が発生し、失敗したと判断されました(問題の内容を適切に示す <code>$OCF_ERR_</code> コードを返す)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_monitor()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> rc

    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    ocf_run frobnicate --test

    <span style="font-style: italic"><span style="color: #9A1900"># この例では、frobnicate は以下の終了コードを返すものとする</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 0: 実行中であり、master に完全に追いついている</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 1: 正常に停止している</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># それ以外: エラー</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"$?"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="color: #993399">0</span><span style="color: #990000">)</span>
            <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$OCF_SUCCESS</span>
            ocf_log debug <span style="color: #FF0000">"Resource is running"</span>
            <span style="color: #990000">;;</span>
        <span style="color: #993399">1</span><span style="color: #990000">)</span>
            <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$OCF_NOT_RUNNING</span>
            ocf_log debug <span style="color: #FF0000">"Resource is not running"</span>
            <span style="color: #990000">;;</span>
        <span style="color: #990000">*)</span>
            ocf_log err <span style="color: #FF0000">"Resource has failed"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>
    <span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$rc</span>
}</tt></pre></div></div>
<div class="paragraph"><p>Stateful (master/slave)リソースエージェントでは、<code>Master</code> role を引き受けるのはどのインスタンスが最適であるかを識別するヒントを提供するために、より精密な監視方式を使用することもあります。詳細は<a href="#_specifying_a_master_preference">master優先度の指定</a>で説明します。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">クラスタマネージャは、リソースが現在実行中であるかどうかをテストするための <em>probe</em> として、<code>monitor</code> アクションを実行することがあります。通常 monitor オペレーションは、 probe のときと「本物の」monitor アクションのときで全く同一の振る舞いになります。しかし、リソースによって probe のときに特別な扱いを必要とする場合には、この目的のために便利な <code>ocf_is_probe</code> 関数が OCF シェル関数ライブラリで提供されています。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_code_validate_all_code_アクション">5.4. <code>validate-all</code> アクション</h3>
<div class="paragraph"><p><code>validate-all</code> アクションは、リソースエージェント設定と動作環境が正しいかをテストします。<code>validate-all</code> は、以下のいずれかの戻り値で終了しなければなりません。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>$OCF_SUCCESS</code>&#8201;&#8212;&#8201;すべて問題なく、設定も正しく使用可能です。
</p>
</li>
<li>
<p>
<code>$OCF_ERR_CONFIGURED</code>&#8201;&#8212;&#8201;ユーザはリソースを正しく設定していません。
</p>
</li>
<li>
<p>
<code>$OCF_ERR_INSTALLED</code>&#8201;&#8212;&#8201;リソースは正しく設定されているように思われますが、 <code>validate-all</code> が実行されているノード上に必要なコンポーネントがありません。
</p>
</li>
<li>
<p>
<code>$OCF_ERR_PERM</code>&#8201;&#8212;&#8201;リソースは正しく設定されており、必要なコンポーネントもすべてありますが、アクセス権限に関する問題(必要なファイルが作成できないなど)が生じています。
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>validate-all</code> は通常一つの関数としてまとめられます。この関数は <code>validate-all</code> アクションが明示的に実行されたときのみならず、他のどの関数からも(正常性確認のために)呼び出されます。したがってリソースエージェントの作成者は、この関数は <code>start</code>, <code>stop</code>, <code>monitor</code> オペレーションさらに probe 中にも呼び出されることを念頭に置いておく必要があります。</p></div>
<div class="paragraph"><p>probe 時にはバリデーション処理において新たな問題が発生します。probe中(すなわちクラスタマネージャが probe 実行時点でリソースは <em>実行されていない</em> ことを期待しているとき)は、いくつかの必須コンポーネントが該当ノード上で利用できないことが <em>期待されている</em> 場合があります。たとえば、ストレージデバイス上の共有データは probe 中は読み出せない、などがあります。したがって <code>validate-all</code> 関数は、 <code>ocf_is_probe</code> 便利関数を使って probe を特別に取り扱うことが必要な場合があります。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_validate_all()</span></span> {
    <span style="font-style: italic"><span style="color: #9A1900"># 最初に設定のエラーを確認する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span> ocf_is_decimal <span style="color: #009900">$OCF_RESKEY_eggs</span><span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
       ocf_log err <span style="color: #FF0000">"eggs is not numeric!"</span>
       <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_CONFIGURED</span>
    <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># 必要なバイナリを確認する</span></span>
    check_binary frobnicate

    <span style="font-style: italic"><span style="color: #9A1900"># データディレクトリを確認する(これは共有ストレージ上にある</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># こともあり得るため、probe 中はこの確認は行わない)</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span> ocf_is_probe<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
       <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span> <span style="color: #990000">[</span> -d <span style="color: #009900">$OCF_RESKEY_datadir</span> <span style="color: #990000">];</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
          ocf_log err <span style="color: #FF0000">"$OCF_RESKEY_datadir does not exist or is not a directory!"</span>
          <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_INSTALLED</span>
       <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_code_meta_data_code_アクション">5.5. <code>meta-data</code> アクション</h3>
<div class="paragraph"><p><code>meta-data</code> アクションは、リソースエージェントのメタデータを標準出力へ書き出します。この出力は <a href="#_metadata">メタデータ</a>で規定されているメタデータフォーマットに準拠しなければなりません。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>foobar_meta_data {
    cat <span style="color: #990000">&lt;&lt;</span>EOF
<span style="color: #990000">&lt;?</span>xml <span style="color: #009900">version</span><span style="color: #990000">=</span><span style="color: #FF0000">"1.0"</span><span style="color: #990000">?&gt;</span>
<span style="color: #990000">&lt;!</span>DOCTYPE resource-agent SYSTEM <span style="color: #FF0000">"ra-api-1.dtd"</span><span style="color: #990000">&gt;</span>
<span style="color: #990000">&lt;</span>resource-agent <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"foobar"</span><span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;</span>version<span style="color: #990000">&gt;</span><span style="color: #993399">0.1</span><span style="color: #990000">&lt;</span>/version<span style="color: #990000">&gt;</span>
  <span style="color: #990000">&lt;</span>longdesc <span style="color: #009900">lang</span><span style="color: #990000">=</span><span style="color: #FF0000">"en"</span><span style="color: #990000">&gt;</span>
<span style="color: #990000">...</span>
EOF
}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_code_promote_code_アクション">5.6. <code>promote</code> アクション</h3>
<div class="paragraph"><p><code>promote</code> アクションは必須ではありません。<em>stateful</em> リソースエージェント、すなわち <code>Master</code> と <code>Slave</code> という二つの異なる <em>役割(role)</em> を区別するエージェントでのみ実装する必要があります。<code>Slave</code> は、statelessリソースエージェントでの <code>Started</code> 状態と機能的には同じです。したがって、通常の(stateless)リソースエージェントは <code>start</code> と <code>stop</code> のみを実装すれば十分ですが、stateful リソースエージェントは <code>Started</code> (<code>Slave</code>) と <code>Master</code> role の間の遷移を可能とするための <code>promote</code> アクションの実装が必要です。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_promote()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> rc

    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースの現在の状態を確認する</span></span>
    foobar_monitor
    <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$?</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"$rc"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="color: #FF0000">"$OCF_SUCCESS"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># slave として実行中。正常であり期待した動作である。</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource is currently running as Slave"</span>
            <span style="color: #990000">;;</span>
        <span style="color: #FF0000">"$OCF_RUNNING_MASTER"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># すでに master である。想定外だが問題ではない。</span></span>
            ocf_log info <span style="color: #FF0000">"Resource is already running as Master"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
            <span style="color: #990000">;;</span>
        <span style="color: #FF0000">"$OCF_NOT_RUNNING"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># 現在停止中である。昇格の前に開始が必要である。</span></span>
            ocf_log info <span style="color: #FF0000">"Resource is currently not running"</span>
            foobar_start
            <span style="color: #990000">;;</span>
        <span style="color: #990000">*)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># リソースの故障。クラスタマネージャに復旧を任せる。</span></span>
            ocf_log err <span style="color: #FF0000">"Unexpected error, cannot promote"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$rc</span>
            <span style="color: #990000">;;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># ここで実際のリソースの昇格を行う(なにか重大な問題が発生した場合は</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># $OCF_ERR_ エラーコードですぐに終了すること)</span></span>
    ocf_run frobnicate --master-mode <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースの昇格を実行したら、昇格が動作したかどうかをチェックする。</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># リソースが非同期で昇格する場合は、エージェントはここで monitor</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 関数を繰り返す。もしリソースが所定のタイムアウト時間以内に Master</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># role とならなかった場合、クラスタマネージャが promote アクションが</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 失敗したと判断する。</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        foobar_monitor
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">[</span> <span style="color: #009900">$?</span> -eq <span style="color: #009900">$OCF_RUNNING_MASTER</span> <span style="color: #990000">];</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource promoted"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource still awaiting promotion"</span>
            sleep <span style="color: #993399">1</span>
        <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_code_demote_code_アクション">5.7. <code>demote</code> アクション</h3>
<div class="paragraph"><p><code>demote</code> アクションは必須ではありません。<em>stateful</em> リソースエージェント、すなわち <code>Master</code> と <code>Slave</code> という二つの異なる <em>役割(role)</em> を区別するエージェントでのみ実装する必要があります。<code>Slave</code> は、statelessリソースエージェントでの <code>Started</code> 状態と機能的には同じです。したがって、通常の(stateless)リソースエージェントは <code>start</code> と <code>stop</code> のみを実装すれば十分ですが、stateful リソースエージェントは <code>Master</code> と <code>Started</code> (<code>Slave</code>) role の間の遷移を可能とするための <code>demote</code> アクションの実装が必要です。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_demote()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> rc

    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースの現在の状態を確認する</span></span>
    foobar_monitor
    <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$?</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"$rc"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="color: #FF0000">"$OCF_RUNNING_MASTER"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># master として実行中。正常であり期待した動作である。</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource is currently running as Master"</span>
            <span style="color: #990000">;;</span>
        <span style="color: #FF0000">"$OCF_SUCCESS"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># すでに slave で実行中である。何もする必要はない。</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource is currently running as Slave"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
            <span style="color: #990000">;;</span>
        <span style="color: #FF0000">"$OCF_NOT_RUNNING"</span><span style="color: #990000">)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># 現在停止中である。この状態において demote アクション</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># が実行されるのは想定外である。エラーで終了し、</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># クラスタマネージャに復旧を任せる。</span></span>
            ocf_log err <span style="color: #FF0000">"Resource is currently not running"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>
            <span style="color: #990000">;;</span>
        <span style="color: #990000">*)</span>
            <span style="font-style: italic"><span style="color: #9A1900"># リソースの故障。クラスタマネージャに復旧を任せる。</span></span>
            ocf_log err <span style="color: #FF0000">"Unexpected error, cannot demote"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$rc</span>
            <span style="color: #990000">;;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># ここで実際のリソースの降格を行う(なにか重大な問題が発生した場合は</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># $OCF_ERR_ エラーコードですぐに終了すること)</span></span>
    ocf_run frobnicate --unset-master-mode <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースの降格を実行したら、降格が動作したかどうかをチェックする。</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># リソースが非同期で降格する場合は、エージェントはここで monitor</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 関数を繰り返す。もしリソースが所定のタイムアウト時間以内に Slave</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># role とならなかった場合、クラスタマネージャが demote アクションが</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 失敗したと判断する。</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="font-weight: bold"><span style="color: #0000FF">true</span></span><span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        foobar_monitor
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">[</span> <span style="color: #009900">$?</span> -eq <span style="color: #009900">$OCF_RUNNING_MASTER</span> <span style="color: #990000">];</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource still awaiting promotion"</span>
            sleep <span style="color: #993399">1</span>
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
            ocf_log debug <span style="color: #FF0000">"Resource demoted"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">break</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_code_migrate_to_code_アクション">5.8. <code>migrate_to</code> アクション</h3>
<div class="paragraph"><p><code>migrate_to</code> アクションは、以下の2つの目的に対応しています。</p></div>
<div class="ulist"><ul>
<li>
<p>
リソース固有の <em>push</em> タイプのマイグレーションを開始します。つまり、リソースがその時点で実行されているノードから、指定したノード <em>に</em> 移動するよう指示します。リソースエージェントは、 <code>$OCF_RESKEY_CRM_meta_migrate_target</code> 環境変数によってその宛先ノードを知ることができます。
</p>
</li>
<li>
<p>
<em>freeze/thaw</em> (または <em>suspend/resume</em> とも呼ばれる)タイプのマイグレーションにおいて、リソースをフリーズします。このモードでは、リソースはこのとき宛先ノードについての情報を必要としません。
</p>
</li>
</ul></div>
<div class="paragraph"><p>以下の例は、pushタイプのマイグレーションを示しています。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_migrate_to()</span></span> {
    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースが実行中でない場合、この時点で終了する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
        ocf_log err <span style="color: #FF0000">"Resource is not running"</span>
        <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>
    <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># ここで実際のリソースの起動を行う(なにか重大な問題が発生した場合は</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># $OCF_ERR_ エラーコードですぐに終了すること)</span></span>
    ocf_run frobnicate --migrate <span style="color: #990000">\</span>
                       --dest<span style="color: #990000">=</span><span style="color: #009900">$OCF_RESKEY_CRM_meta_migrate_target</span> <span style="color: #990000">\</span>
                       <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> OCF_ERR_GENERIC
    <span style="color: #990000">...</span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
<div class="paragraph"><p>これに対し、freeze/thawタイプのマイグレーションは以下のようなfreezeオペレーションを実装します。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_migrate_to()</span></span> {
    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースが実行中でない場合、この時点で終了する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
        ocf_log err <span style="color: #FF0000">"Resource is not running"</span>
        <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>
    <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># ここで実際のリソースの処理を開始する(なにか重大な問題が発生した場合は</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># $OCF_ERR_ エラーコードですぐに終了すること)</span></span>
    ocf_run frobnicate --freeze <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> OCF_ERR_GENERIC
    <span style="color: #990000">...</span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_code_migrate_from_code_アクション">5.9. <code>migrate_from</code> アクション</h3>
<div class="paragraph"><p><code>migrate_from</code> アクションは、以下の2つの目的に対応しています。</p></div>
<div class="ulist"><ul>
<li>
<p>
リソース固有の <em>push</em> タイプのマイグレーションを完了する。つまり、マイグレーションが正しく終了したかどうか、リソースがローカルノードで実行されているかどうか、をチェックします。リソースエージェントは、マイグレーション元を <code>$OCF_RESKEY_CRM_meta_migrate_source</code> 環境変数によって知ることができます。
</p>
</li>
<li>
<p>
<em>freeze/thaw</em> (または <em>suspend/resume</em> とも呼ばれる)タイプのマイグレーションにおいてリソースを解凍する。このモードでは、リソースはこのときソースノードについての情報を必要としません。
</p>
</li>
</ul></div>
<div class="paragraph"><p>以下の例は、pushタイプのマイグレーションを示しています。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_migrate_from()</span></span> {
    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースのマイグレーションを実行したら、正常に再開したかどうかを</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># チェックする。リソースが非同期で開始する場合は、エージェントは</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># ここで monitor 関数を繰り返す。もしリソースが所定のタイムアウト時間</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 以内に実行されなかった場合、クラスタマネージャが migrate_from</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># アクションが失敗したと判断する。</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">!</span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        ocf_log debug <span style="color: #FF0000">"Resource has not yet migrated, waiting"</span>
        sleep <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
<div class="paragraph"><p>これに対して、freeze/thawタイプのマイグレーションは以下のようなthawオペレーションを実装します。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_migrate_from()</span></span> {
    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># ここで実際のリソースの起動を行う(なにか重大な問題が発生した場合は</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># $OCF_ERR_ エラーコードですぐに終了すること)</span></span>
    ocf_run frobnicate --thaw <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> OCF_ERR_GENERIC

    <span style="font-style: italic"><span style="color: #9A1900"># リソースのマイグレーションを実行したら、正常に再開したかどうかを</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># チェックする。リソースが非同期で開始する場合は、エージェントは</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># ここで monitor 関数を繰り返す。もしリソースが所定のタイムアウト時間</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 以内に実行されなかった場合、クラスタマネージャが migrate_from</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># アクションが失敗したと判断する。</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">!</span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        ocf_log debug <span style="color: #FF0000">"Resource has not yet migrated, waiting"</span>
        sleep <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_a_id__literal_notify_literal_action_a_code_notify_code_アクション">5.10. <a id="_literal_notify_literal_action"></a><code>notify</code> アクション</h3>
<div class="paragraph"><p>通知を用いることによって、cloneインスタンス(および clone の拡張である master/slave リソース)はその状態をお互いに通知し合うことができます。通知を有効にすると、cloneのすべてのインスタンスのすべてのアクションに対して <code>pre</code> および <code>post</code> 通知が発生します。そしてクラスタマネージャは、<em>すべての</em> クローンインスタンスに対して <code>notify</code> オペレーションを実行します。<code>notify</code> オペレーションに対しては、以下の追加の環境変数がリソースエージェントの実行中に渡されます。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>$OCF_RESKEY_CRM_meta_notify_type</code> --通知タイプ ( <code>pre</code> または <code>post</code> )
</p>
</li>
<li>
<p>
<code>$OCF_RESKEY_CRM_meta_notify_operation</code>&#8201;&#8212;&#8201;通知の対象となるオペレーション(アクション) ( <code>start</code> , <code>stop</code> , <code>promote</code> , <code>demote</code> など)
</p>
</li>
<li>
<p>
<code>$OCF_RESKEY_CRM_meta_notify_start_uname</code>&#8201;&#8212;&#8201;リソースを起動しているノードの名前( <code>start</code> の通知のみ)
</p>
</li>
<li>
<p>
<code>$OCF_RESKEY_CRM_meta_notify_stop_uname</code>&#8201;&#8212;&#8201;リソースを停止しているノードの名前 ( <code>stop</code> の通知のみ)
</p>
</li>
<li>
<p>
<code>$OCF_RESKEY_CRM_meta_notify_master_uname</code>&#8201;&#8212;&#8201;リソースがその時点で Master role <em>になっている</em> ノードの名前
</p>
</li>
<li>
<p>
<code>$OCF_RESKEY_CRM_meta_notify_promote_uname</code>&#8201;&#8212;&#8201;リソースがその時に Master role <em>に昇格している</em> ノードの名前 ( <code>promote</code> の通知のみ)
</p>
</li>
<li>
<p>
<code>$OCF_RESKEY_CRM_meta_notify_demote_uname</code>&#8201;&#8212;&#8201;ソースがその時に Slave role <em>に降格している</em> ノードの名前 ( <code>demote</code> の通知のみ)
</p>
</li>
</ul></div>
<div class="paragraph"><p>通知は、"pull" 型を使っている master/slave リソース、すなわち master が発行者で slave が購読者のような場合において特に便利です。master は昇格が発生したときにのみ利用可能となることは明らかなので、slave 側では正しい発行者から購読するよう自分自身を設定するために、"pre-promote" 通知を利用することができます。</p></div>
<div class="paragraph"><p>同様に、発行者が master 状態では無くなった後に購読者が購読をやめたい場合があり、この目的のために "post-demote" 通知を使うことができます。</p></div>
<div class="paragraph"><p>この考え方については以下に示す例を参照してください。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_notify()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> type_op
    <span style="color: #009900">type_op</span><span style="color: #990000">=</span><span style="color: #FF0000">"${OCF_RESKEY_CRM_meta_notify_type}-${OCF_RESKEY_CRM_meta_notify_operation}"</span>

    ocf_log debug <span style="color: #FF0000">"Received $type_op notification."</span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"$type_op"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="color: #FF0000">'pre-promote'</span><span style="color: #990000">)</span>
            ocf_run frobnicate --slave-mode <span style="color: #990000">\</span>
                               --master<span style="color: #990000">=</span><span style="color: #009900">$OCF_RESKEY_CRM_meta_notify_promote_uname</span> <span style="color: #990000">\</span>
                               <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>
            <span style="color: #990000">;;</span>
        <span style="color: #FF0000">'post-demote'</span><span style="color: #990000">)</span>
            ocf_run frobnicate --unset-slave-mode <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>
            <span style="color: #990000">;;</span>
    <span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">master/slaveリソースエージェントは、同時に複数の master が存在できる <em>マルチマスタ</em> 設定をサポートすることができます。この場合 <code>$OCF_RESKEY_CRM_meta_notify_*_uname</code> 変数は、例に示したような一つのホスト名ではなく、空白文字で区切られたホスト名のリストを持ちます。こういった状況では、リソースエージェントはこのリストを正しく繰り返し処理しなければなりません。</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">訳注: 上記のコード例では、master 側からの通知を受けて slave 側で実行する処理を意図しているようにも読めますが、実際には master 側でも通知を受け取って同じ処理が実行されるので、実装する際は適切な処理が行われるよう注意してください。</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_id__script_variables_a_スクリプト変数">6. <a id="_script_variables"></a>スクリプト変数</h2>
<div class="sectionbody">
<div class="paragraph"><p>本項では、リソースエージェントで一般に利用可能な、主に利便性を目的とした変数の概要について説明します。エージェントの実行中に利用できるその他の変数については、<a href="#_environment_variables">環境変数</a>と <a href="#_return_codes">戻り値</a>を参照してください。</p></div>
<div class="sect2">
<h3 id="_code_ocf_ra_version_major_code">6.1. <code>$OCF_RA_VERSION_MAJOR</code></h3>
<div class="paragraph"><p>クラスタマネージャが現在使用しているリソースエージェントAPIのメジャーバージョン番号。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_ra_version_minor_code">6.2. <code>$OCF_RA_VERSION_MINOR</code></h3>
<div class="paragraph"><p>クラスタマネージャが現在使用しているリソースエージェントAPIのマイナーバージョン番号。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_root_code">6.3. <code>$OCF_ROOT</code></h3>
<div class="paragraph"><p>OCFリソースエージェントのディレクトリ階層のルート。これはリソースエージェントが変更してはいけません。通常は <code>/usr/lib/ocf</code> となります。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_functions_dir_code">6.4. <code>$OCF_FUNCTIONS_DIR</code></h3>
<div class="paragraph"><p>リソースエージェントシェル関数ライブラリ( <code>ocf-shellfuncs</code> )が配置されているディレクトリ。これは通常、 <code>$OCF_ROOT</code> を元に定義されており、リソースエージェントが変更してはいけません。しかしこの変数は、新規または修正リソースエージェントをテストするときに、コマンドラインから上書きされる場合があります。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_exit_reason_prefix_code">6.5. <code>$OCF_EXIT_REASON_PREFIX</code></h3>
<div class="paragraph"><p>リソースエージェントからのエラーメッセージを表示するときに使われるプレフィックス。スクリプト関数はこれを内部的に使うので、シェルベースのスクリプトでは明示的に利用する必要はありません。</p></div>
</div>
<div class="sect2">
<h3 id="_a_id__literal_ocf_resource_instance_literal_a_code_ocf_resource_instance_code">6.6. <a id="_literal_ocf_resource_instance_literal"></a><code>$OCF_RESOURCE_INSTANCE</code></h3>
<div class="paragraph"><p>リソースインスタンス名。primitive (clone でも stateful でもない) リソースに関しては、これは単なるリソース名となります。clonesおよびstatefulリソースに対しては、これはprimitive名の後にコロンとcloneインスタンス番号(例: <code>p_foobar:0</code> )が続きます。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_resource_type_code">6.7. <code>$OCF_RESOURCE_TYPE</code></h3>
<div class="paragraph"><p>現在のリソースのリソース種別。例: IPaddr2。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocf_resource_provider_code">6.8. <code>$OCF_RESOURCE_PROVIDER</code></h3>
<div class="paragraph"><p>リソースプロバイダ。例: heartbeat。 リソースエージェント API バージョン 1.0 では、クラスタマネージャによっては設定されていないことがあります。</p></div>
</div>
<div class="sect2">
<h3 id="_code___ocf_action_code">6.9. <code>$__OCF_ACTION</code></h3>
<div class="paragraph"><p>現在起動されているアクション。これは、クラスタマネージャがリソースエージェントを起動するときに指定した１つ目のコマンドライン引数と同一です。</p></div>
</div>
<div class="sect2">
<h3 id="_code___script_name_code">6.10. <code>$__SCRIPT_NAME</code></h3>
<div class="paragraph"><p>リソースエージェントの名前。これは、先行するディレクトリ名を削除したリソースエージェントスクリプトのベース名と同一です。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ha_rsctmp_code">6.11. <code>$HA_RSCTMP</code></h3>
<div class="paragraph"><p>リソースエージェントにより使用される一時ディレクトリです。システム起動シーケンスにおいて(LSB準拠のLinuxディストリビューションでは)、このディレクトリはシステム起動時に空になっていることが保障されています。したがってノードが再起動した後は、このディレクトリに古いデータが残存していることはありません。</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_便利関数">7. 便利関数</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ログ出力_code_ocf_log_code">7.1. ログ出力: <code>ocf_log</code></h3>
<div class="paragraph"><p>リソースエージェントでは、ログ出力を行いたい場合は <code>ocf_log</code> 関数を使ってください。この便利なログラッパーは以下のように実行します。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ocf_log <span style="color: #990000">&lt;</span>severity<span style="color: #990000">&gt;</span> <span style="color: #FF0000">"Log message"</span></tt></pre></div></div>
<div class="paragraph"><p>以下の重要度レベル(severity)をサポートします。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>debug</code>&#8201;&#8212;&#8201;デバッグメッセージ用。ほとんどのログ設定ではデフォルトでこのレベルを抑制します。
</p>
</li>
<li>
<p>
<code>info</code>&#8201;&#8212;&#8201;エージェントの振る舞いや状態に関する情報メッセージ。
</p>
</li>
<li>
<p>
<code>warn</code>&#8201;&#8212;&#8201;警告用。これは、回復不能なエラー <em>ではない</em> 想定外の動作を表すメッセージです。
</p>
</li>
<li>
<p>
<code>err</code> --エラー用。このログレベルは原則的に、適切なエラーコードと合わせて <code>exit</code> の直前でのみ使われるべきです。
</p>
</li>
<li>
<p>
<code>crit</code>&#8201;&#8212;&#8201;クリティカルエラー用。 <code>err</code> と同様、このログレベルはリソースエージェントがエラーコードで終了するときでない限り使うべきではありません。ごく稀にしか使われません。
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_バイナリのテスト_code_have_binary_code_および_code_check_binary_code">7.2. バイナリのテスト: <code>have_binary</code> および <code>check_binary</code></h3>
<div class="paragraph"><p>リソースエージェントは、特定の実行ファイルが利用可能であるかのテストを必要とする場合があります。この場合 <code>have_binary</code> 関数が便利です。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">!</span> have_binary frobnicate<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
   ocf_log warn <span style="color: #FF0000">"Missing frobnicate binary, frobnication disabled!"</span>
<span style="font-weight: bold"><span style="color: #0000FF">fi</span></span></tt></pre></div></div>
<div class="paragraph"><p>バイナリのないことがリソースに対して致命的な問題となる場合は、<code>check_binary</code> 関数を使います。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>check_binary frobnicate</tt></pre></div></div>
<div class="paragraph"><p><code>check_binary</code> は、指定した実行ファイルの存在(および実行可能であること)の確認と、それが存在しないもしくは実行できない場合に <code>$OCF_ERR_INSTALLED</code> で終了することを簡易に記述する方法です。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">テストするバイナリの指定がフルパスでない場合、<code>have_binary</code> および <code>check_binary</code> はいずれも <code>$PATH</code> を参照します。バイナリのインストールパスはディストリビューションやユーザの方針によって異なるため、通常はフルパスでのテストは <em>しない</em> ほうが良いでしょう。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_コマンドの実行とその出力の記録_code_ocf_run_code">7.3. コマンドの実行とその出力の記録: <code>ocf_run</code></h3>
<div class="paragraph"><p>リソースエージェントがコマンドを実行し、その出力を記録したい場合は、<code>ocf_run</code> 便利関数を使ってください。以下の例のように実行します。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ocf_run frobnicate --spam<span style="color: #990000">=</span>eggs <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span></tt></pre></div></div>
<div class="paragraph"><p>上記に指定したコマンドの場合、リソースエージェントは <code>frobnicate --spam=eggs</code> を実行し、その出力と終了コードを記録します。終了コードが0以外(エラーを示す)の場合、<code>ocf_run</code> はコマンドの出力をログの重要度 <code>err</code> としてログ出力し、その後リソースエージェントは終了します。終了コードが0(成功を示す)の場合、コマンドの出力はログの重要度 <code>info</code> でログ出力します。</p></div>
<div class="paragraph"><p>コマンド実行が成功したときの出力は無視したい、という場合は、<code>ocf_run</code> の <code>-q</code> オプションが使えます。下記の例では <code>ocf_run</code> はコマンドの終了コードが0以外の場合のみログを出力します。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ocf_run -q frobnicate --spam<span style="color: #990000">=</span>eggs <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span></tt></pre></div></div>
<div class="paragraph"><p>最後に、ゼロ以外の終了コードのときのコマンド出力をエラー_以外_の重要度でログ出力を行いたい場合、<code>ocf_run</code> に <code>-info</code> または <code>-warn</code> オプションを追加することでできます。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ocf_run -warn frobnicate --spam<span style="color: #990000">=</span>eggs</tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_ロック_code_ocf_take_lock_code_および_code_ocf_release_lock_on_exit_code">7.4. ロック: <code>ocf_take_lock</code> および <code>ocf_release_lock_on_exit</code></h3>
<div class="paragraph"><p>一つのクラスタ設定の中で同じ種類のリソースが別々に存在し、それらのアクションが並列で実行されてはならない、という場合が存在します。同じマシン上でアクションが同時実行されないようにするために、リソースエージェントは <code>ocf_take_lock</code> と <code>ocf_release_lock_on_exit</code> 便利関数を使うことができます。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">LOCKFILE</span><span style="color: #990000">=</span><span style="color: #009900">${HA_RSCTMP}</span>/foobar
ocf_release_lock_on_exit <span style="color: #009900">$LOCKFILE</span>

<span style="font-weight: bold"><span style="color: #000000">foobar_start()</span></span> {
    <span style="color: #990000">...</span>
    ocf_take_lock <span style="color: #009900">$LOCKFILE</span>
    <span style="color: #990000">...</span>
}</tt></pre></div></div>
<div class="paragraph"><p><code>ocf_take_lock</code> は、指定された <code>$LOCKFILE</code> を獲得しようとします。これができなかった場合、0秒から1秒の間のランダムな時間スリープし、そしてリトライします。<code>ocf_release_lock_on_exit</code> はエージェントが終了するときに(どんな場合でも)ロックファイルを解放します。</p></div>
</div>
<div class="sect2">
<h3 id="_数値のテスト_code_ocf_is_decimal_code">7.5. 数値のテスト: <code>ocf_is_decimal</code></h3>
<div class="paragraph"><p>特にパラメータの検証処理において、指定された値が数値であるかどうかをテストすることは有用です。このために <code>ocf_is_decimal</code> 関数があります。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>foobar_validate_all() {
    if ! ocf_is_decimal $OCF_RESKEY_eggs; then
        ocf_log err "eggs is not numeric!"
        exit $OCF_ERR_CONFIGURED
    fi
    ...
}</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_論理値のテスト_code_ocf_is_true_code">7.6. 論理値のテスト: <code>ocf_is_true</code></h3>
<div class="paragraph"><p>リソースエージェントがbooleanパラメータを定義している場合、このパラメータに対してユーザが指定できる値には  <code>0</code>/<code>1</code>, <code>true</code>/<code>false</code>, <code>on</code>/<code>off</code> があります。しかしこれらすべての値をリソースエージェントの中でテストするのは面倒なので、代わりに <code>ocf_is_true</code> 便利関数を使ってください。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> ocf_is_true <span style="color: #009900">$OCF_RESKEY_superfrobnicate</span><span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    ocf_run frobnicate --super
<span style="font-weight: bold"><span style="color: #0000FF">fi</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content"><code>ocf_is_true</code> は、空の変数あるいは存在しない変数に対して使われると、常に <code>1</code> の終了コードを返します。これは <code>false</code> と同じです。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_バージョン比較_code_ocf_version_cmp_code">7.7. バージョン比較: <code>ocf_version_cmp</code></h3>
<div class="paragraph"><p>リソースエージェントではインストールされているソフトウェアのバージョン番号をチェックしたくなる場合があります。<code>ocf_version_cmp</code> は必要な処理を全て面倒見てくれます。</p></div>
<div class="paragraph"><p>リターンコードは以下です。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>0</code>&#8201;&#8212;&#8201;一つ目のバージョンは二つ目のバージョンより小さい(早い)
</p>
</li>
<li>
<p>
<code>1</code>&#8201;&#8212;&#8201;二つのバージョンは同一である
</p>
</li>
<li>
<p>
<code>2</code>&#8201;&#8212;&#8201;一つ目のバージョンは二つ目のバージョンより大きい(遅い)
</p>
</li>
<li>
<p>
<code>3</code>&#8201;&#8212;&#8201;どちらかの引数がバージョン文字列として認識できなかった
</p>
</li>
</ul></div>
<div class="paragraph"><p>バージョン番号には数字、ドット、ダッシュが含まれることが許されます。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="color: #009900">v</span><span style="color: #990000">=</span>`gooey --version`
ocf_version_cmp <span style="color: #FF0000">"$v"</span> <span style="color: #993399">12.0</span><span style="color: #990000">.</span><span style="color: #993399">8</span>-<span style="color: #993399">1</span>
<span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #009900">$?</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="color: #993399">0</span><span style="color: #990000">)</span> ocf_log err <span style="color: #FF0000">"we do not support version $v, it is too old"</span>
           <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_INSTALLED</span>
        <span style="color: #990000">;;</span>
        <span style="color: #990000">[</span><span style="color: #993399">12</span><span style="color: #990000">])</span> <span style="color: #990000">;;</span> <span style="font-style: italic"><span style="color: #9A1900"># we can work with versions &gt;= 12.0.8-1</span></span>
        <span style="color: #993399">3</span><span style="color: #990000">)</span> ocf_log err <span style="color: #FF0000">"gooey produced version &lt;$v&gt;, too funky for me"</span>
           <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_INSTALLED</span>
        <span style="color: #990000">;;</span>
<span style="font-weight: bold"><span style="color: #0000FF">esac</span></span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_疑似リソース_code_ha_pseudo_resource_code">7.8. 疑似リソース: <code>ha_pseudo_resource</code></h3>
<div class="paragraph"><p>「疑似リソース」というのは、実際に実行可能なプロセスのようなものを start したり stop したりするのではなく、単にアクションを実行し、そのアクションが実行されたか否かを何らかの形式で追跡することが必要なリソースエージェントのことです。この例としては <code>portblock</code> リソースエージェントがあります。</p></div>
<div class="paragraph"><p>疑似リソースのためのリソースエージェントでは <code>ha_pseudo_resource</code> 便利関数を使うことができます。この関数はリソースの状態を追いかける <em>追跡ファイル</em> を使用します。<code>foobar</code> が疑似リソースを管理するものとして作られているとすると、その <code>start</code> アクションは以下のようになります。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_start()</span></span> {
    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    <span style="font-style: italic"><span style="color: #9A1900"># リソースが既に実行中の場合はこの段階で終了する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
        ocf_log info <span style="color: #FF0000">"Resource is already running"</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
    <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># 疑似リソースを開始する</span></span>
    ha_pseudo_resource <span style="color: #009900">${OCF_RESOURCE_INSTANCE}</span> start

    <span style="font-style: italic"><span style="color: #9A1900"># リソース起動を実行したら、正常に起動したかどうかをチェックする。</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># リソースが非同期で起動する場合は、エージェントはここで monitor</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 関数を繰り返す。もしリソースが所定のタイムアウト時間以内に起動</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># しなかった場合、クラスタマネージャが start アクションが失敗した</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># と判断する。</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">!</span> foobar_monitor<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        ocf_log debug <span style="color: #FF0000">"Resource has not started yet, waiting"</span>
        sleep <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># _すべてが_ 期待通り成功した場合にのみ $OCF_SUCCESS を返却する</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$OCF_SUCCESS</span>
}</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_慣習">8. 慣習</h2>
<div class="sectionbody">
<div class="paragraph"><p>この章では、長年続くリソースエージェントのリポジトリの中から発生した慣習をまとめて記載しています。リソースエージェントの作成者はこれらの慣習に必ずしも従う必要はありませんが、<a href="https://ja.wikipedia.org/wiki/%E9%A9%9A%E3%81%8D%E6%9C%80%E5%B0%8F%E3%81%AE%E5%8E%9F%E5%89%87">驚き最小の原則</a>に則り従った方が良いです。慣習に従ったリソースエージェントの方がより理解しやすく、レビューもしやすくなります。</p></div>
<div class="sect2">
<h3 id="_よく利用されるパラメータ名">8.1. よく利用されるパラメータ名</h3>
<div class="paragraph"><p>パラメータ名の中にはすでにいくつものリソースエージェントで利用されているものがあります。新規にリソースエージェントを作成するときは以下の例にならうのが一般的に良い考えです。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>binary</code>&#8201;&#8212;&#8201;サーバのデーモンなど、リソースを主に管理するバイナリ名
</p>
</li>
<li>
<p>
<code>config</code>&#8201;&#8212;&#8201;設定ファイルのフルパス名
</p>
</li>
<li>
<p>
<code>pid</code>&#8201;&#8212;&#8201;プロセスID(PID)を保持するファイルのフルパス名
</p>
</li>
<li>
<p>
<code>log</code>&#8201;&#8212;&#8201;ログファイルのフルパス名
</p>
</li>
<li>
<p>
<code>socket</code>&#8201;&#8212;&#8201;リソースが管理する UNIX ソケットのフルパス名
</p>
</li>
<li>
<p>
<code>ip</code>&#8201;&#8212;&#8201;デーモンが使用する IP アドレス
</p>
</li>
<li>
<p>
<code>port</code>&#8201;&#8212;&#8201;デーモンが使用する TCP または UDP ポート番号
</p>
</li>
</ul></div>
<div class="paragraph"><p>言うまでもなく、これらのうち実際に使用する意味のあるもののみをリソースエージェントに実装すべきです。</p></div>
</div>
<div class="sect2">
<h3 id="_パラメータのデフォルト値">8.2. パラメータのデフォルト値</h3>
<div class="paragraph"><p>リソースエージェントパラメータのデフォルトは、 <code>_default</code> 接尾語のついた変数を初期化して設定するようにします。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># デフォルト値</span></span>
<span style="color: #009900">OCF_RESKEY_superfrobnicate_default</span><span style="color: #990000">=</span><span style="color: #993399">0</span>

<span style="color: #990000">:</span> <span style="color: #009900">${OCF_RESKEY_superfrobnicate=${OCF_RESKEY_superfrobnicate_default}}</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">リソースエージェントは、メタデータで <code>required</code> と指定されていないパラメータに対してデフォルトを設定しなければなりません。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_バイナリには_code_path_code_を反映する">8.3. バイナリには <code>PATH</code> を反映する</h3>
<div class="paragraph"><p>リソースエージェントでバイナリ名を設定するためのパラメータ(デーモンや監視処理のためのクライアントコマンドなど)を設けたい場合、そのパラメータは <code>PATH</code> 環境変数を反映する方が良いです。フルパスを与えるべきではありません。したがって、以下の方法</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># 良い例 -- こうすべき</span></span>
<span style="color: #009900">OCF_RESKEY_frobnicate_default</span><span style="color: #990000">=</span><span style="color: #FF0000">"frobnicate"</span>
<span style="color: #990000">:</span> <span style="color: #009900">${OCF_RESKEY_frobnicate="${OCF_RESKEY_frobnicate_default}"}</span></tt></pre></div></div>
<div class="paragraph"><p>は、フルパスを指定した以下の例よりもより望ましい方法です。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># 悪い例 -- できれば避ける</span></span>
<span style="color: #009900">OCF_RESKEY_frobnicate_default</span><span style="color: #990000">=</span><span style="color: #FF0000">"/usr/local/sbin/frobnicate"</span>
<span style="color: #990000">:</span> <span style="color: #009900">${OCF_RESKEY_frobnicate="${OCF_RESKEY_frobnicate_default}"}</span></tt></pre></div></div>
<div class="paragraph"><p>このルールはデフォルト値に対しても当てはまります。</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_特記事項">9. 特記事項</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ライセンス">9.1. ライセンス</h3>
<div class="paragraph"><p>リソースエージェントのコントリビュータは可能な限り、新たなリソースエージェントには GNU General Public License (GPL) バージョン2以降を使用することを <em>推奨</em> します。しかしシェル関数ライブラリは(GPL以外のエージェントでも利用可能とするため)GNU Lesser General Public License (LGPL) バージョン2.1以降としてライセンスしており、これを厳密に強制はしていません。</p></div>
<div class="paragraph"><p>リソースエージェントはそのライセンスをエージェントのソースコード中に明示的に <em>記述しなければなりません</em> 。</p></div>
</div>
<div class="sect2">
<h3 id="_ロケール設定">9.2. ロケール設定</h3>
<div class="paragraph"><p><a href="#_initialization">初期化</a>で説明されている通りに <code>ocf-shellfuncs</code> を読み込むと、リソースエージェントの <code>LANG</code> および <code>LC_ALL</code> は自動的に <code>C</code> ロケールに設定されます。こうすることでリソースエージェントは常に <code>C</code> ロケールで動作することが期待できるので、自分で <code>LANG</code> や各種 <code>LC_</code> 環境変数をリセットする必要はありません。</p></div>
</div>
<div class="sect2">
<h3 id="_実行中のプロセスに対するテスト">9.3. 実行中のプロセスに対するテスト</h3>
<div class="paragraph"><p>あるプロセスが(プロセスIDが分かっている場合)現在実行中であるかどうかをテストする方法として、<code>0</code> シグナルを送ってエラーを取得する、という方法がよく用いられます。以下の例のようになります。</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> kill -s <span style="color: #993399">0</span> `cat <span style="color: #009900">$daemon_pid_file</span>`<span style="color: #990000">;</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
    ocf_log debug <span style="color: #FF0000">"Process is currently running"</span>
<span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
    ocf_log warn <span style="color: #FF0000">"Process is dead, removing pid file"</span>
    rm -f <span style="color: #009900">$daemon_pid_file</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">この例よりもより優れた方法として、クライアントプロセスからデーモンに接続して <em>機能</em> をテストする方法があります。<a href="#_literal_monitor_literal_action"><code>monitor</code></a>アクションで例を示しています。</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_a_id__specifying_a_master_preference_a_master_優先度の指定">9.4. <a id="_specifying_a_master_preference"></a>master 優先度の指定</h3>
<div class="paragraph"><p>Stateful (master/slave)リソースは自身の <em>master 優先度</em> を設定する必要があります。これは、<code>Master</code> role に昇格するのに最適なインスタンスはどれか、クラスタマネージャにヒントを提供するためです。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">複数のインスタンスが同一の正の master 優先度を持つことができます。この場合クラスタリソースマネージャは、昇格するリソースエージェントを自動的に選択します。しかし、 <em>すべての</em> インスタンスの master スコアが 0(デフォルト)である場合、クラスタマネージャはどのインスタンスも昇格しません。つまり、少なくとも1つのインスタンスが正のmasterスコアを持つことが重要です。</td>
</tr></table>
</div>
<div class="paragraph"><p>この目的のために <code>crm_master</code> が重宝します。この便利な <code>crm_attribute</code> のラッパーは、<code>master-<a href="#_literal_ocf_resource_instance_literal">$OCF_RESOURCE_INSTANCE</a></code> という名前でそれが実行されているノードのノード属性を設定し、指定された値をこの属性に与えます。クラスタマネージャはそれを対応するインスタンスの昇格スコアに変換し、昇格選択のスコアの基にします。</p></div>
<div class="paragraph"><p>Statefulリソースエージェントは、<a href="#_literal_monitor_literal_action"><code>monitor</code></a>あるいは<a href="#_literal_notify_literal_action"><code>notify</code></a>アクションの中で <code>crm_master</code> を実行するのが一般的です。</p></div>
<div class="paragraph"><p>以下の例は、<code>foobar</code> リソースエージェントが、以下のいずれかに基づいて終了コードが返却されるバイナリを実行することによってアプリケーションの状態をテストすることができると仮定した例です。</p></div>
<div class="ulist"><ul>
<li>
<p>
リソースが master role である、もしくは slave であるが master に追いついている(いかなる意味でも最新データを持っている)。あるいは、
</p>
</li>
<li>
<p>
リソースが slave role であるが、なんらかの形で非同期レプリケーションが master より「遅れている」。あるいは、
</p>
</li>
<li>
<p>
リソースは正常に停止している。あるいは、
</p>
</li>
<li>
<p>
リソースは予期しない故障が発生している。
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">foobar_monitor()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> rc

    <span style="font-style: italic"><span style="color: #9A1900"># 設定が不正な場合は即終了する</span></span>
    foobar_validate_all <span style="color: #990000">||</span> <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$?</span>

    ocf_run frobnicate --test

    <span style="font-style: italic"><span style="color: #9A1900"># この例では、frobnicate は以下の終了コードを返すものとする</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 0: 実行中であり、master に完全に追いついている</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 1: 正常に停止している</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 2: 実行中であるが、master より遅れている</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># それ以外: エラー</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #FF0000">"$?"</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span>
        <span style="color: #993399">0</span><span style="color: #990000">)</span>
            <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$OCF_SUCCESS</span>
            ocf_log debug <span style="color: #FF0000">"Resource is running"</span>
            <span style="font-style: italic"><span style="color: #9A1900"># 高い master 優先度を設定する。現在の master は</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># 常にこの値 + 1 を持つ。現在 slave である場合は</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># 高い優先度を持ち、master が故障した場合に次の順番で</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># 引き継げるようにする。</span></span>
            crm_master -l reboot -v <span style="color: #993399">100</span>
            <span style="color: #990000">;;</span>
        <span style="color: #993399">1</span><span style="color: #990000">)</span>
            <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$OCF_NOT_RUNNING</span>
            ocf_log debug <span style="color: #FF0000">"Resource is not running"</span>
            <span style="font-style: italic"><span style="color: #9A1900"># このノードの master 優先度を削除する</span></span>
            crm_master -l reboot -D
            <span style="color: #990000">;;</span>
        <span style="color: #993399">2</span><span style="color: #990000">)</span>
            <span style="color: #009900">rc</span><span style="color: #990000">=</span><span style="color: #009900">$OCF_SUCCESS</span>
            ocf_log debug <span style="color: #FF0000">"Resource is lagging behind master"</span>
            <span style="font-style: italic"><span style="color: #9A1900"># 低い master 優先度を設定する。もしこの時点で master が</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># 故障した場合、master から遅れていない他の slave が</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># 存在する場合は、より高い master 優先度が勝ち、その</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># slave が新たな master となるようにする。</span></span>
            crm_master -l reboot -v <span style="color: #993399">5</span>
            <span style="color: #990000">;;</span>
        <span style="color: #990000">*)</span>
            ocf_log err <span style="color: #FF0000">"Resource has failed"</span>
            <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #009900">$OCF_ERR_GENERIC</span>
    <span style="font-weight: bold"><span style="color: #0000FF">esac</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #009900">$rc</span>
}</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_リソースエージェントをテストする">10. リソースエージェントをテストする</h2>
<div class="sectionbody">
<div class="paragraph"><p>本項では、リソースエージェントの自動テスト方法について説明します。テストは開発における重要な要素です。リソースエージェントを新規に作成する場合、既存のリソースエージェントを修正する場合、どちらに対しても重要です。</p></div>
<div class="sect2">
<h3 id="_code_ocf_tester_code_を用いたテスト">10.1. <code>ocf-tester</code> を用いたテスト</h3>
<div class="paragraph"><p>リソースエージェントのリポジトリ(およびインストールされたリソースエージェントパッケージ)には、 <code>ocf-tester</code> という名前のユーティリティが含まれています。このシェルスクリプトによって、リソースエージェントの機能を効率的かつ簡単にテストすることができます。</p></div>
<div class="paragraph"><p><code>ocf-tester</code> は一般的には、<code>root</code> によって以下のように起動します。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ocf-tester -n &lt;name&gt; [-o &lt;param&gt;=&lt;value&gt; ... ] &lt;resource agent&gt;</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<code>&lt;name&gt;</code> は、任意のリソース名です。
</p>
</li>
<li>
<p>
<code>&lt;param&gt;=&lt;value&gt;</code> は、 <code>-o</code> オプションで、テスト用に設定したいリソースパラメータに応じていくつでも設定できます。
</p>
</li>
<li>
<p>
<code>&lt;resource agent&gt;</code> はリソースエージェントへのフルパスです。
</p>
</li>
</ul></div>
<div class="paragraph"><p><code>ocf-tester</code> を起動すると、すべての必須アクションを実行し、アクションが<a href="#_resource_agent_actions">リソースエージェントアクション</a>で説明している通りの動作となっていることを強制します。</p></div>
<div class="paragraph"><p>また、オプショナルなアクションに対するテストも行います。オプショナルアクションは記載されている場合は期待通り動作する必要がありますが、もし実装されていなくても <code>ocf-tester</code> はエラーとは見なしません。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content"><code>ocf-tester</code> は、アクションの「予行演習(dry run)」を行うものではありません。またリソースのなんらかのダミーを作成するものでもありません。そうではなく、これは実際のリソースエージェントをそのまま実行するものです。つまりデータベースのオープンやクローズ、ファイルシステムのマウント、仮想マシンの起動や停止、などが行われることもあります。注意して利用してください。</td>
</tr></table>
</div>
<div class="paragraph"><p>例として、<code>foobar</code> リソースエージェントに対しては以下のように <code>ocf-tester</code> を実行します。</p></div>
<div class="listingblock">
<div class="content">
<pre><code># ocf-tester -n foobartest \
             -o superfrobnicate=true \
             -o datadir=/tmp \
             /home/johndoe/ra-dev/foobar
Beginning tests for /home/johndoe/ra-dev/foobar...
* Your agent does not support the notify action (optional)
* Your agent does not support the reload action (optional)
/home/johndoe/ra-dev/foobar passed all tests</code></pre>
</div></div>
<div class="paragraph"><p>リソースエージェントの振る舞いがよく把握できない動作をした場合、開発したばかりのソフトウェアではたいていそうなりますが、<code>-v</code> オプションや <code>-d</code> オプションを使ってより多くの出力を出すことができます。これだけではよくわからない場合、<code>ocf-tester</code> に <code>-X</code> を与えることでリソースエージェントのトレースを行うことができます(出力をファイルにリダイレクトするのを忘れないこと。あなたが超速で読める人でない限り)。</p></div>
</div>
<div class="sect2">
<h3 id="_code_ocft_code_を用いたテスト">10.2. <code>ocft</code> を用いたテスト</h3>
<div class="paragraph"><p><code>ocft</code> はリソースエージェント用のテストツールです。<code>ocf-tester</code> との大きな違いは、<code>ocft</code> では複雑なテスト環境の作成を自動化している点です。パッケージのインストールや任意のシェルスクリプト実行も可能です。</p></div>
<div class="sect3">
<h4 id="_code_ocft_code_のコンポーネント">10.2.1. <code>ocft</code> のコンポーネント</h4>
<div class="paragraph"><p><code>ocft</code> には以下のコンポーネントがあります。</p></div>
<div class="ulist"><ul>
<li>
<p>
テストケースジェネレータ (<code>/usr/sbin/ocft</code>)&#8201;&#8212;&#8201;テストケース設定ファイルからシェルスクリプトを生成する
</p>
</li>
<li>
<p>
設定ファイル (<code>/usr/share/resource-agents/ocft/configs/</code>)&#8201;&#8212;&#8201;あるリソースエージェントに対する環境設定とテストケースを含む設定ファイル
</p>
</li>
<li>
<p>
テスト用スクリプトが格納される <code>/var/lib/resource-agents/ocft/cases/</code> 、ただし通常この内容を知る必要はありません。
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_テスト環境のカスタマイズ">10.2.2. テスト環境のカスタマイズ</h4>
<div class="paragraph"><p><code>ocft</code> はリソースエージェントの実行環境を、環境変数を変更する(OCF で規定されているインタフェースによって)、またはその場限りのシェルスクリプトを実行する(例えばファイルのパーミッションを変更したりファイルシステムを unmount したりなど)によって変更します。</p></div>
</div>
<div class="sect3">
<h4 id="_テストの実行方法">10.2.3. テストの実行方法</h4>
<div class="paragraph"><p>あなたはテストを実行したいソフトウェア(リソース)についてよく知っている必要があります。全ての必要なシナリオについて、全ての期待する動作条件、期待範囲外の動作条件、それらに対してリソースエージェントが取るべきリアクション、などのスケッチを描きます。そしてこれらの動作条件と期待する動作結果を <code>ocft</code> テストケースとしてコード化する必要があります。<code>ocft</code> の実行は簡単です。</p></div>
<div class="listingblock">
<div class="content">
<pre><code># ocft make &lt;RA&gt;
# ocft test &lt;RA&gt;</code></pre>
</div></div>
<div class="paragraph"><p>一つ目のコマンドはテストケースに対するスクリプトを生成しており、二つ目のコマンドでそれを実行して結果を確認しています。</p></div>
</div>
<div class="sect3">
<h4 id="_code_ocft_code_設定ファイル構文">10.2.4. <code>ocft</code> 設定ファイル構文</h4>
<div class="paragraph"><p>4つのトップレベルオプションが存在しており、それぞれに複数のサブオプションが存在します。</p></div>
<div class="sect4">
<h5 id="_code_config_code_トップレベルオプション"><code>CONFIG</code> (トップレベルオプション)</h5>
<div class="paragraph"><p>このオプションはグローバルであり、全てのテストケースに対して影響を与えます。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>AgentRoot</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>AgentRoot /usr/lib/ocf/resource.d/xxx</code></pre>
</div></div>
<div class="paragraph"><p>通常はリソースエージェントの場所は <code>heartbeat</code> プロバイダ配下にあるという前提になっています。テストしたいエージェントがそれ以外のベンダによって配布されている場合 <code>AgentRoot</code> を設定します。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>InstallPackage</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>InstallPackage package [package2 [...]]</code></pre>
</div></div>
<div class="paragraph"><p>テストに必要なパッケージをインストールします。必要なパッケージがすでにインストールされている場合はスキップします。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>HangTimeout</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>HangTimeout secs</code></pre>
</div></div>
<div class="paragraph"><p>一回の RA 実行に許される最大時間です。この時間を超過した場合、実行は失敗したとみなされます。</p></div>
</div>
<div class="sect4">
<h5 id="_code_setup_agent_code_トップレベルオプション"><code>SETUP-AGENT</code> (トップレベルオプション)</h5>
<div class="listingblock">
<div class="content">
<pre><code>SETUP-AGENT
  bash commands</code></pre>
</div></div>
<div class="paragraph"><p>RAのテスト実行前に初期化が必要な場合、そのための bash コードをここに書くことができます。初期化は実行は一回のみです。もし再度初期化の実行が必要な場合は、<code>/tmp/.[AGENT_NAME]_set</code> スタンプファイルを削除してください。</p></div>
</div>
<div class="sect4">
<h5 id="_code_case_code_トップレベルオプション"><code>CASE</code> (トップレベルオプション)</h5>
<div class="listingblock">
<div class="content">
<pre><code>CASE "description"</code></pre>
</div></div>
<div class="paragraph"><p>これがテストスイートのメインの構成要素です。一つのテストケースを一つの <code>CASE</code> トップレベルオプションとして記述します。</p></div>
<div class="paragraph"><p>一つのテストケースは通常複数のサブオプションで構成され、その後に <code>RunAgent</code> サブオプションが続きます。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>Var</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>Var VARIABLE=value</code></pre>
</div></div>
<div class="paragraph"><p>リソースエージェントの環境変数を設定します。通常は OCF_RESKEY_xxx を設定します。一点注意点として、"=" の両サイドには空白を入れないでください。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>Unvar</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>Unvar VARIABLE [VARIABLE2 [...]]</code></pre>
</div></div>
<div class="paragraph"><p>環境変数を削除します。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>Include</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>Include macro_name</code></pre>
</div></div>
<div class="paragraph"><p><em>macro_name</em> の文をインクルードします。以下の <code>CASE-BLOCK</code> の説明を参照してください。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>Bash</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>Bash bash_codes</code></pre>
</div></div>
<div class="paragraph"><p>このオプションは OS の環境を設定するために使用します。ここに BASH のコードを挿入することでシステムを如何様にでもカスタマイズできます。システムが復旧不可能となる結果を引き起こさないように注意してください。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>BashAtExit</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>BashAtExit bash_codes</code></pre>
</div></div>
<div class="paragraph"><p>このオプションは、次のテストケースを正常に実行できるように OS 環境を復旧させるために使用します。もちろん <em>Bash</em> オプションを復旧のために使用することもできます。しかし、もし処理中になんらかの間違いが発生した場合、スクリプトは復旧用のコードを実行せずすぐに終了してしまいます。このような場合は、終了前にシステム環境を復旧させることができる BashAtExit を使用すべきです。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>RunAgent</code> (サブオプション)
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>RunAgent cmd [ret_value]</code></pre>
</div></div>
<div class="paragraph"><p>このオプションはリソースエージェントを実行します。"cmd" は、start, status, stop&#8230; などのリソースエージェントのパラメータです。二つ目のパラメータは省略可能です。指定することで、リソースエージェントの実行時に実際の返却値と期待する返却値を比較することができるようになります。もし異なっていればバグが見つかったということです。</p></div>
<div class="paragraph"><p>また、サブオプションをローカルではなくリモートホストで実行することも可能です。プロトコルには ssh が使用され、コマンドはバックグラインドで実行されます。サブオプション名に <code>@&lt;ipaddr&gt;</code> 接尾辞を付与するだけです。例えば、</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Bash@192.168.1.100 date</code></pre>
</div></div>
<div class="paragraph"><p>は、date コマンドを実行します。リモートコマンドはバックグラウンドで実行されます。</p></div>
<div class="paragraph"><p>要注意: ssh による自動化は、事前に環境を知ることができないためできるとは限りません。"node2" のような「よく利用される」ホスト名を使用すればよいかも? またコマンドはバックグラウンドで実行されるため、終了コードがチェックできるかも不明です。最後に、<a href="mailto:Var@node">Var@node</a> には意味があるのか? あるいは現在の環境を何らかの方法でリモートへコピーする? おそらくここには実例が必要でしょう。</p></div>
<div class="paragraph"><p>全般的に実例が必要です。</p></div>
</div>
<div class="sect4">
<h5 id="_code_case_block_code_トップレベルオプション"><code>CASE-BLOCK</code> (トップレベルオプション)</h5>
<div class="listingblock">
<div class="content">
<pre><code>CASE-BLOCK macro_name</code></pre>
</div></div>
<div class="paragraph"><p><code>CASE-BLOCK</code> オプションは、 <code>CASE</code> から <code>Include</code> されるマクロを定義します。<code>CASE</code> の全てのサブオプションが <code>CASE-BLOCK</code> で利用可能です。</p></div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_リソースエージェントのインストールとパッケージング">11. リソースエージェントのインストールとパッケージング</h2>
<div class="sectionbody">
<div class="paragraph"><p>本項では、リソースエージェントの作成とテストが終わった後何をすべきか、つまりどこにインストールして、どのようにあなた独自のアプリケーションパッケージもしくは Linux-HA リソースエージェントリポジトリに含めるのか、について説明します。</p></div>
<div class="sect2">
<h3 id="_リソースエージェントのインストール">11.1. リソースエージェントのインストール</h3>
<div class="paragraph"><p>リソースエージェントをあなた独自のプロジェクトの一部に含めたい場合、それに適した場所にインストールしてください。この場合リソースエージェントは、 <code>/usr/lib/ocf/resource.d/&lt;provider&gt;</code> ディレクトリにインストールします。ここで <code>&lt;provider&gt;</code> は、あなたのプロジェクトの名前、もしくはリソースエージェントを識別するための何らかの名前を入れます。</p></div>
<div class="paragraph"><p>たとえば、 <code>foobar</code> リソースエージェントを <code>fortytwo</code> という名前のプロジェクトの一部としてパッケージしようとしている場合、このリソースエージェントの正しいフルパスは <code>/usr/lib/ocf/resource.d/fortytwo/foobar</code> となります。リソースエージェントは <code>0755</code> (<code>-rwxr-xr-x</code>)パーミッションビットでインストールすることを忘れないでください。</p></div>
<div class="paragraph"><p>この方法に従ってインストールを行うことで、 OCF準拠クラスタリソースマネージャは、リソースエージェントを正しく識別、解釈、実行できるようになります。たとえば上記に示したインストールパスは、Pacemakerクラスタマネージャでは <code>ocf:fortytwo:foobar</code> リソースタイプ識別子に対応付けされます。</p></div>
</div>
<div class="sect2">
<h3 id="_リソースエージェントのパッケージング">11.2. リソースエージェントのパッケージング</h3>
<div class="paragraph"><p>パッケージリソースをあなた独自のプロジェクトの一部としてパッケージする場合は、本項で概説する注意事項に従ってください。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">もし、リソースエージェントを Linux-HA リソースエージェントリポジトリに投稿したい場合、<a href="#_submitting_resource_agents">リソースエージェントの投稿</a>で必要な情報を参照してください。</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_a_id__rpm_packaging_a_rpmパッケージング">11.2.1. <a id="_rpm_packaging"></a>RPMパッケージング</h4>
<div class="paragraph"><p>OCFリソースエージェントは 、<code>&lt;toppackage&gt;-resource-agents</code> という名前でRPMサブパッケージに入れることを推奨します。このとき、自分のプロバイダディレクトリをそのパッケージが所有し、ディレクトリ階層や便利シェル関数を提供しているアップストリーム <code>resource-agents</code> パッケージへの依存関係を持つようにしてください。以下に例として RPM スペックファイルの一部抜粋を示します。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>%package resource-agents
Summary: OCF resource agent for Foobar
Group: System Environment/Base
Requires: %{name} = %{version}-%{release}, resource-agents

%description resource-agents
This package contains the OCF-compliant resource agents for Foobar.

%files resource-agents
%defattr(755,root,root,-)
%dir %{_prefix}/lib/ocf/resource.d/fortytwo
%{_prefix}/lib/ocf/resource.d/fortytwo/foobar</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">RPM スペックファイルに <code>%package</code> 宣言を記述すると、RPMはそれを <code>Name</code> , <code>Version</code> , <code>License</code> などの項目をトップレベルから継承したサブパッケージであると認識します。サブパッケージは、その名前の前にトップレベルパッケージの名前を自動的に付加します。したがって、上記の抜粋の例では(パッケージ名 <code>Name</code> が <code>foobar</code> であるとすると) <code>foobar-resource-agents</code> という名前のサブパッケージを作成します。</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_debianパッケージング">11.2.2. Debianパッケージング</h4>
<div class="paragraph"><p>Debianパッケージの場合、<a href="#_rpm_packaging">RPM</a>と同じようにリソースエージェントを保持する別のパッケージを作成することを推奨しますが、この場合は <code>cluster-agents</code> パッケージへの依存関係を持つ必要があります。</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">本項では <code>debhelper</code> でパッケージングすることを前提とします。</td>
</tr></table>
</div>
<div class="paragraph"><p>以下に <code>debian/control</code> の一部抜粋の例を示します。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Package: foobar-cluster-agents
Priority: extra
Architecture: all
Depends: cluster-agents
Description: OCF-compliant resource agents for Foobar</code></pre>
</div></div>
<div class="paragraph"><p>また、これとは別に <code>.install</code> ファイルも作成します。 <code>foobar</code> リソースエージェントを <code>fortytwo</code> のサブパッケージとしてインストールする例に従うと、<code>debian/fortytwo-cluster-agents.install</code> ファイルは以下の内容で構成されます。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>usr/lib/ocf/resource.d/fortytwo/foobar</code></pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_a_id__submitting_resource_agents_a_リソースエージェントの投稿">11.3. <a id="_submitting_resource_agents"></a>リソースエージェントの投稿</h3>
<div class="paragraph"><p>リソースエージェントを自分独自のパッケージではなく、アップストリームのリソースエージェントリポジトリ(<a href="https://github.com/ClusterLabs/resource-agents">GitHub 上の ClusterLabs リポジトリ</a>)に投稿したい場合は、本項で説明する手順に従ってください。</p></div>
<div class="paragraph"><p>まず、以下のコマンドで、アップストリームリポジトリの作業用コピー (Git <em>clone</em>) を作成してください。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git clone git://github.com/ClusterLabs/resource-agents</code></pre>
</div></div>
<div class="paragraph"><p>そしてあなたのリソースエージェントを <code>heartbeat</code> サブディレクトリにコピーしてください。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>cd resource-agents/heartbeat
cp /path/to/your/local/copy/of/foobar .
chmod 0755 foobar
cd ..</code></pre>
</div></div>
<div class="paragraph"><p>次に、<code>resource-agents/heartbeat</code> 配下の <code>Makefile.am</code> ファイルを編集し、あなたの新リソースエージェントを <code>ocf_SCRIPTS</code> リストに追加してください。これによりエージェントが正しくインストールされるようになります。</p></div>
<div class="paragraph"><p>最後に <code>resource-agents/doc/man</code> 配下の Makefile.am を開き 、<code>ocf_heartbeat_&lt;name&gt;.7</code> を <code>man_MANS</code> 変数に追加してください。これにより、リソースエージェントのマニュアルページがメタデータから自動的に作成され、そのマニュアルページが正しい場所にインストールされるようになります。</p></div>
<div class="paragraph"><p>そしてここで、あなたの新しいリソースエージェントと二つの Makefile に行った修正をチェンジセットに追加します。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git add heartbeat/foobar
git add heartbeat/Makefile.am
git add doc/man/Makefile.am
git commit</code></pre>
</div></div>
<div class="paragraph"><p>コミットメッセージには以下のような分かりやすい説明を記述してください。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>High: foobar: new resource agent

This new resource agent adds functionality to manage a foobar service.
It supports being configured as a primitive or as a master/slave set,
and also optionally supports superfrobnication.</code></pre>
</div></div>
<div class="paragraph"><p>これで、メーリングリスト上でレビューするためのパッチセットが準備できました。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git send-email --to=linux-ha-dev@lists.linux-ha.org</code></pre>
</div></div>
<div class="paragraph"><p><code>git send-email</code> は、手元で行われた修正でアップストリームリポジトリに含まれていないものを全てまとめて、メール用に適切なフォーマットを行い、メーリングリストに投稿します。<code>git send-email</code> を利用する際の詳細な設定については <code>man git-send-email</code> を参照してください。</p></div>
<div class="paragraph"><p>あなたの新リソースエージェントのマージが受諾されれば、アップストリーム開発者の誰かがあなたのパッチをアップストリームリポジトリに push するでしょう。ここまでくれば、アップストリームからのチェックアウトを更新し、あなたの作成したパッチセットを削除することができます。</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git reset --hard origin/master
git pull</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_リソースエージェントの維持管理">11.4. リソースエージェントの維持管理</h3>
<div class="paragraph"><p>あなたが何かのリソースエージェントの管理を行ったり、コードベースに継続的にコントリビューションを行う場合は、GitHub 上であなた専用の <code>ClusterLabs/resource-agents</code> リポジトリの <em>フォーク(fork)</em> を管理するのが一般的で良い方法です。</p></div>
<div class="paragraph"><p>このためには以下を行います。</p></div>
<div class="ulist"><ul>
<li>
<p>
GitHub のアカウントをまだ持っていない場合は <a href="https://github.com/signup">GitHub アカウントを作成する</a>。
</p>
</li>
<li>
<p>
<a href="https://github.com/ClusterLabs/resource-agents"><code>resource-agents</code> リポジトリ</a>を <a href="https://help.github.com/articles/fork-a-repo/">フォーク(Fork)</a> する。
</p>
</li>
<li>
<p>
あなたの個人用のフォークを手元の作業用コピーとしてクローンする。
</p>
</li>
</ul></div>
<div class="paragraph"><p>リソースエージェントの作業を行う場合、ぜひ「こまめにcommit、頻繁にcommit」を心がけてください。commit は後からいつでも <code>git rebase -i</code> でひとまとめにすることができます。</p></div>
<div class="paragraph"><p>必要な修正が完了し他の人にレビューして欲しいと思ったら、その修正をあなたの GitHub のフォークにプッシュして、<code>linux-ha-dev</code> メーリングリストに投稿します。</p></div>
<div class="paragraph"><p>レビューが完了したら、必要な要望を反映しツリーを整理して、そしてプルリクエストを発行します。これには二つの方法があります。</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>git request-pull</code> コマンドを使って、あなたの修正をまとめて要約したメールの雛形を作成することができます。これに必要な情報を追加してメーリングリストに送信してください。メールの件名に <code>[GIT PULL]</code> のプレフィックスを付与するのは良い方法です。アップストリームメンテナがメッセージを見つけやすくなります。
</p>
</li>
<li>
<p>
GitHub 上で直接プルリクエストを発行することもできます。GitHub は新しいプルリクエストがあったことをアップストリームメンテナに自動的にメールで通知します。プルリクエストの発行に関する詳細については <a href="https://help.github.com/articles/about-pull-requests/">github:help</a> を参照してください。
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2024-05-31 11:46:25 JST
</div>
</div>
</body>
</html>
